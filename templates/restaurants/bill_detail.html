{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="h-[calc(100vh-60px)] md:h-[calc(100vh-100px)] flex flex-col md:flex-row gap-4 md:gap-6 print:hidden">
    
    <div class="flex-1 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col border border-gray-100 order-1 md:order-1">
        <div class="p-3 md:p-5 bg-gray-50 border-b flex justify-between items-center shrink-0">
            <div>
                <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2">
                    üçΩÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-normal">
                        {{ order_items|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </span>
                </h2>
                <p class="text-xs md:text-sm text-gray-500 mt-1">‡πÇ‡∏ï‡πä‡∏∞: <span class="font-bold text-gray-700">{{ table.name }}</span></p>
            </div>
            <a href="{% url 'cashier_dashboard' %}" class="flex items-center gap-1 text-gray-500 hover:text-blue-600 transition font-medium text-xs md:text-sm bg-white border px-3 py-1.5 rounded-lg shadow-sm hover:shadow">
                &larr; <span class="hidden md:inline">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span><span class="md:hidden">‡∏Å‡∏•‡∏±‡∏ö</span>
            </a>
        </div>
        
        <div class="flex-1 overflow-y-auto bg-white">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-gray-500 text-xs md:text-sm uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="hidden md:table-cell py-3 px-4 font-semibold w-12 text-center">#</th>
                        <th class="py-3 px-4 font-semibold w-auto">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th class="hidden md:table-cell py-3 px-4 font-semibold text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="hidden md:table-cell py-3 px-4 font-semibold text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                        <th class="py-3 px-2 md:px-4 font-semibold text-right w-20 md:w-auto">‡∏£‡∏ß‡∏°</th>
                        <th class="py-3 px-2 md:px-4 font-semibold text-center w-12 md:w-16">‡∏•‡∏ö</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 divide-y divide-gray-100">
                    {% for item in order_items %}
                    <tr class="hover:bg-blue-50/50 transition duration-150 group text-sm md:text-base">
                        <td class="hidden md:table-cell py-3 px-4 text-center text-gray-400 text-xs">{{ forloop.counter }}</td>
                        <td class="py-3 px-4 align-top">
                            <div class="font-bold text-gray-800 text-sm md:text-base">{{ item.menu_name }}</div>
                            <div class="md:hidden text-xs text-gray-500 mt-1">
                                <span class="font-bold text-gray-700">x{{ item.quantity }}</span> 
                                <span class="text-gray-400">@ {{ item.price|floatformat:0 }}</span>
                            </div>
                            <div class="text-[10px] md:text-xs text-gray-400 mt-1 flex items-center gap-1">
                                <span class="hidden md:inline">üïí {{ item.order_time|date:"H:i" }}</span>
                                {% if item.status == 'PENDING' %}
                                    <span class="text-yellow-600 bg-yellow-50 px-1.5 py-0.5 rounded border border-yellow-100">‡∏£‡∏≠</span>
                                {% elif item.status == 'COOKING' %}
                                    <span class="text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">‡∏õ‡∏£‡∏∏‡∏á</span>
                                {% elif item.status == 'SERVED' %}
                                    <span class="text-green-600 bg-green-50 px-1.5 py-0.5 rounded border border-green-100">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="hidden md:table-cell py-3 px-4 text-center font-medium bg-gray-50/50">x{{ item.quantity }}</td>
                        <td class="hidden md:table-cell py-3 px-4 text-right text-gray-500">{{ item.price|floatformat:0 }}</td>
                        <td class="py-3 px-2 md:px-4 text-right font-bold text-gray-800 align-top md:align-middle">{{ item.total|floatformat:0 }}</td>
                        <td class="py-3 px-2 md:px-4 text-center align-top md:align-middle">
                            <form action="{% url 'delete_order_item' item.id %}" method="POST" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ {{ item.menu_name }}?');">
                                {% csrf_token %}
                                <button type="submit" class="text-gray-300 hover:text-red-500 p-1.5 md:p-2 rounded-full hover:bg-red-50 transition group-hover:text-red-400" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-20">
                            <div class="flex flex-col items-center justify-center text-gray-300">
                                <span class="text-4xl md:text-6xl mb-4">üçΩÔ∏è</span>
                                <span class="text-base md:text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="bg-gray-50 px-4 py-2 border-t text-xs md:text-sm text-gray-600 flex justify-between items-center shrink-0">
            <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°: <b>{{ order_items|length }}</b></span>
            <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="text-green-600 font-bold">Active</span></span>
        </div>
    </div>

    <div class="w-full md:w-96 bg-white rounded-xl shadow-lg flex flex-col h-auto md:h-fit border border-gray-100 overflow-hidden shrink-0 order-2 md:order-2">
        
        <div class="p-4 md:p-6 bg-linear-to-br from-blue-600 to-indigo-700 text-white relative overflow-hidden">
            <div class="absolute -right-6 -top-6 bg-white opacity-10 rounded-full w-32 h-32"></div>
            <div class="flex justify-between items-end md:block">
                <div>
                    <h3 class="text-xs md:text-sm opacity-90 mb-1 font-medium tracking-wide">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Grand Total)</h3>
                    <div class="text-3xl md:text-5xl font-bold tracking-tight">‡∏ø{{ grand_total|floatformat:2 }}</div>
                </div>
                <div class="text-right md:hidden text-blue-100 text-xs">
                     <p>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ subtotal|floatformat:0 }}</p>
                     {% if restaurant.service_charge_percent > 0 %}<p>SV: {{ service_charge_amount|floatformat:0 }}</p>{% endif %}
                     {% if restaurant.vat_percent > 0 %}<p>VAT: {{ vat_amount|floatformat:0 }}</p>{% endif %}
                </div>
            </div>
        </div>

        <div class="hidden md:block p-4 md:p-6 space-y-2 md:space-y-3 border-b border-dashed bg-white">
            <div class="flex justify-between text-gray-600 text-xs md:text-sm">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Subtotal)</span>
                <span class="font-bold text-gray-800">‡∏ø{{ subtotal|floatformat:2 }}</span>
            </div>
            {% if restaurant.service_charge_percent > 0 %}
            <div class="flex justify-between text-gray-500 text-xs">
                <span>Service Charge ({{ restaurant.service_charge_percent }}%)</span>
                <span>‡∏ø{{ service_charge_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if restaurant.vat_percent > 0 %}
            <div class="flex justify-between text-gray-500 text-xs">
                <span>VAT ({{ restaurant.vat_percent }}%)</span>
                <span>‡∏ø{{ vat_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
        </div>

        <div class="p-4 md:p-6 bg-gray-50 mt-auto">
            
            <div class="grid grid-cols-2 gap-2 md:gap-3 mb-4 md:mb-6">
                <button onclick="window.clearCustomerScreen()" type="button" 
                    class="flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-2 md:py-3 rounded-lg md:rounded-xl hover:bg-gray-100 hover:text-red-600 font-bold transition shadow-sm text-xs md:text-sm">
                    üö´ ‡∏õ‡∏¥‡∏î‡∏à‡∏≠
                </button>
                <button onclick="window.sendToCustomer()" type="button" 
                    class="flex items-center justify-center gap-2 bg-indigo-600 text-white py-2 md:py-3 rounded-lg md:rounded-xl hover:bg-indigo-700 font-bold shadow-md transition hover:-translate-y-0.5 text-xs md:text-sm">
                    üöÄ ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î
                </button>
            </div>
            
            <form method="post" action="{% url 'close_bill' table.id %}" onsubmit="if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ')) { return handleCloseBill(event); } else { return false; }">
                {% csrf_token %}
                <div class="mb-3 md:mb-4">
                    <label class="block text-[10px] md:text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="cash" class="peer sr-only" checked>
                            <div class="text-center border rounded-lg p-2 text-gray-600 peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 transition text-xs md:text-sm">
                                üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="qr" class="peer sr-only">
                            <div class="text-center border rounded-lg p-2 text-gray-600 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition text-xs md:text-sm">
                                üì≤ ‡∏™‡πÅ‡∏Å‡∏ô
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 md:py-4 rounded-xl font-bold text-base md:text-lg shadow-lg shadow-green-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                    ‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞
                </button>
            </form>
            
            <div class="grid grid-cols-2 gap-2 mt-3">
                <button onclick="printReceipt('thermal')" class="text-gray-500 hover:text-gray-800 hover:bg-gray-200 bg-gray-100 rounded-lg text-[10px] md:text-xs py-2 flex items-center justify-center gap-1 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡πà‡∏≠
                </button>
                <button onclick="printReceipt('full')" class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 bg-white border border-blue-100 rounded-lg text-[10px] md:text-xs py-2 flex items-center justify-center gap-1 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ï‡πá‡∏°
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {
        /* 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô */
        body * {
            visibility: hidden;
            height: 0;
            overflow: hidden;
        }

        /* 2. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Container ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à */
        #print-container, #print-container * {
            visibility: visible;
            height: auto;
            overflow: visible;
        }

        /* 3. ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
        #print-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 0;
            display: block !important; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà */
            z-index: 9999;
            background-color: white;
        }

        /* 4. Logic ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏° Class ‡∏ó‡∏µ‡πà body */
        body.printing-thermal #receipt-thermal { display: block !important; }
        body.printing-full #receipt-full { display: block !important; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        #receipt-thermal, #receipt-full { display: none; }

        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
        @page { size: auto; margin: 0; }
    }
</style>

<div id="print-container" class="hidden">
    <div id="receipt-thermal" class="bg-white text-black font-mono text-[12px] leading-tight p-2 max-w-[80mm] mx-auto">
        <div class="text-center mb-3">
            <h1 class="text-lg font-bold mb-1">{{ restaurant.name }}</h1>
            <p class="text-[10px] text-gray-600">{{ restaurant.address|default:"-" }}</p>
            <p class="text-[10px]">Tel: {{ restaurant.phone|default:"-" }}</p>
            {% if restaurant.tax_id %}<p class="text-[10px]">Tax ID: {{ restaurant.tax_id }}</p>{% endif %}
            
            <div class="border-b-2 border-dashed border-gray-400 my-2"></div>
            
            <div class="flex justify-between text-[10px]">
                <span>‡πÇ‡∏ï‡πä‡∏∞: {{ table.name }}</span>
                <span>{% now "d/m/y H:i" %}</span>
            </div>
            <div class="flex justify-between text-[10px]">
                <span>Bill: {{ bill_number }}</span>
                <span>Cashier: {{ request.user.username }}</span>
            </div>
        </div>

        <table class="w-full text-[12px] mb-2">
            <thead>
                <tr class="border-b border-black">
                    <th class="text-left py-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th class="text-right py-1 w-8">#</th>
                    <th class="text-right py-1 w-14">‡∏£‡∏ß‡∏°</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td class="py-1 pr-1 align-top">
                        {{ item.menu_name }}
                    </td>
                    <td class="text-right align-top">{{ item.quantity }}</td>
                    <td class="text-right align-top">{{ item.total|floatformat:0 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="border-t-2 border-dashed border-gray-400 my-2 pt-1">
            <div class="flex justify-between text-[11px]">
                <span>‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
                <span>{{ subtotal|floatformat:2 }}</span>
            </div>
            {% if restaurant.service_charge_percent > 0 %}
            <div class="flex justify-between text-[10px] text-gray-600">
                <span>SVC {{ restaurant.service_charge_percent }}%</span>
                <span>{{ service_charge_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if restaurant.vat_percent > 0 %}
            <div class="flex justify-between text-[10px] text-gray-600">
                <span>VAT {{ restaurant.vat_percent }}%</span>
                <span>{{ vat_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
        </div>
        <div class="flex justify-between text-xl font-bold mt-2 mb-4">
            <span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
            <span>{{ grand_total|floatformat:2 }}</span>
        </div>
        <div class="text-center text-[10px] mb-8">
            <p>*** ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ***</p>
        </div>
    </div>

    <div id="receipt-full" class="bg-white text-black font-sans p-8 max-w-2xl mx-auto border border-gray-200">
        <div class="flex justify-between items-start mb-6 border-b pb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">{{ restaurant.name }}</h1>
                <p class="text-sm text-gray-600 mt-1 max-w-sm">{{ restaurant.address|default:"-" }}</p>
                <p class="text-sm text-gray-600">Tel: {{ restaurant.phone|default:"-" }}</p>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold text-gray-400 uppercase tracking-widest">Receipt</div>
                <div class="mt-2 text-sm">
                    <p><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</b> {{ bill_number }}</p>
                    <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> {% now "d M Y H:i" %}</p>
                    <p><b>‡πÇ‡∏ï‡πä‡∏∞:</b> {{ table.name }}</p>
                    <p><b>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</b> {{ request.user.username }}</p>
                </div>
            </div>
        </div>

        <table class="w-full mb-6 text-sm border-collapse">
            <thead>
                <tr class="bg-gray-100 text-gray-600 uppercase text-xs tracking-wider">
                    <th class="py-3 px-4 text-center border font-semibold w-16">#</th>
                    <th class="py-3 px-4 text-left border font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th class="py-3 px-4 text-center border font-semibold w-24">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th class="py-3 px-4 text-right border font-semibold w-32">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th class="py-3 px-4 text-right border font-semibold w-32">‡∏£‡∏ß‡∏°</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td class="py-3 px-4 text-center border text-gray-500">{{ forloop.counter }}</td>
                    <td class="py-3 px-4 text-left border font-medium text-gray-900">{{ item.menu_name }}</td>
                    <td class="py-3 px-4 text-center border">{{ item.quantity }}</td>
                    <td class="py-3 px-4 text-right border">{{ item.price|floatformat:2 }}</td>
                    <td class="py-3 px-4 text-right border font-bold">{{ item.total|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="flex justify-end">
            <div class="w-64 space-y-2 text-sm">
                <div class="flex justify-between text-gray-600"><span>‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span>{{ subtotal|floatformat:2 }}</span></div>
                {% if restaurant.service_charge_percent > 0 %}
                <div class="flex justify-between text-gray-600"><span>SVC ({{ restaurant.service_charge_percent }}%)</span><span>{{ service_charge_amount|floatformat:2 }}</span></div>
                {% endif %}
                {% if restaurant.vat_percent > 0 %}
                <div class="flex justify-between text-gray-600"><span>VAT ({{ restaurant.vat_percent }}%)</span><span>{{ vat_amount|floatformat:2 }}</span></div>
                {% endif %}
                <div class="flex justify-between text-xl font-bold text-gray-900 border-t pt-2 mt-2"><span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>‡∏ø{{ grand_total|floatformat:2 }}</span></div>
            </div>
        </div>
    </div>
</div>

<div id="raw-order-data" style="display: none;">
    {% for item in order_items %}
    <div data-name="{{ item.menu_name }}" data-quantity="{{ item.quantity }}" data-price="‡∏ø{{ item.total|floatformat:2 }}"></div>
    {% endfor %}
</div>

<script>
    // 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    const restaurantId = "{{ restaurant.id|default:'' }}"; 
    
    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á WebSocket Connection
    let socket = null;
    if (restaurantId) {
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/';
        socket = new WebSocket(wsUrl);
        socket.onopen = function () { console.log("‚úÖ WebSocket Connected!"); };
        socket.onerror = function(error) { console.warn("‚ùå WebSocket Error:", error); };
    }

    // 3. Helper Functions
    function getOrderItems() {
        const rawElements = document.querySelectorAll('#raw-order-data div');
        return Array.from(rawElements).map(el => ({
            name: el.getAttribute('data-name'),
            quantity: parseInt(el.getAttribute('data-quantity')),
            price: el.getAttribute('data-price')
        }));
    }

    // 4. Exposed Functions (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö window.func ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ onclick ‡πÉ‡∏ô HTML ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå)
    window.sendToCustomer = function() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
            return;
        }
        const items = getOrderItems();
        const grandTotal = "{{ grand_total|floatformat:2 }}";
        socket.send(JSON.stringify({
            command: 'show_customer_payment',
            items: items,
            total: '‡∏ø' + grandTotal
        }));
    };

    window.clearCustomerScreen = function() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ command: 'hide_customer_payment' }));
        }
    };

    window.handleCloseBill = function(event) {
        window.clearCustomerScreen();
        return true;
    };

    // 5. Print Function (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic)
    window.printReceipt = function(mode) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Class ‡∏ó‡∏µ‡πà body ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å CSS ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏≠‡∏±‡∏ô‡πÑ‡∏´‡∏ô
        document.body.classList.remove('printing-thermal', 'printing-full');
        document.body.classList.add(mode === 'thermal' ? 'printing-thermal' : 'printing-full');
        
        // ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        window.print();

        // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å) ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ Class ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏≤‡∏á Browser ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏ó‡∏≥‡πÉ‡∏´‡πâ setTimeout ‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        setTimeout(() => {
            document.body.classList.remove('printing-thermal', 'printing-full');
        }, 500);
    };
</script>
{% endblock %}
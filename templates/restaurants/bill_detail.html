{% extends "base.html" %}

{% block content %}
<div class="h-[calc(100vh-100px)] flex flex-col md:flex-row gap-6">
    
    <div class="flex-1 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col border border-gray-100">
        <div class="p-5 bg-gray-50 border-b flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    üçΩÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-normal">
                        {{ order_items|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </span>
                </h2>
                <p class="text-sm text-gray-500 mt-1">‡πÇ‡∏ï‡πä‡∏∞: <span class="font-bold text-gray-700">{{ table.name }}</span></p>
            </div>
            <a href="{% url 'cashier_dashboard' %}" class="flex items-center gap-1 text-gray-500 hover:text-blue-600 transition font-medium text-sm bg-white border px-3 py-1.5 rounded-lg shadow-sm hover:shadow">
                &larr; ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
        
        <div class="flex-1 overflow-y-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-gray-500 text-sm uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="py-3 px-4 font-semibold w-12 text-center">#</th>
                        <th class="py-3 px-4 font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th class="py-3 px-4 font-semibold text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="py-3 px-4 font-semibold text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                        <th class="py-3 px-4 font-semibold text-right">‡∏£‡∏ß‡∏°</th>
                        <th class="py-3 px-4 font-semibold text-center w-16">‡∏•‡∏ö</th> </tr>
                </thead>
                <tbody class="text-gray-700 divide-y divide-gray-100">
                    {% for item in order_items %}
                    <tr class="hover:bg-blue-50/50 transition duration-150 group">
                        <td class="py-3 px-4 text-center text-gray-400 text-xs">{{ forloop.counter }}</td>
                        <td class="py-3 px-4">
                            <div class="font-bold text-gray-800">{{ item.menu_name }}</div>
                            <div class="text-xs text-gray-400 mt-0.5 flex items-center gap-1">
                                üïí {{ item.order_time|date:"H:i" }}
                                {% if item.status == 'PENDING' %}
                                    <span class="text-yellow-600 bg-yellow-50 px-1 rounded">‡∏£‡∏≠</span>
                                {% elif item.status == 'COOKING' %}
                                    <span class="text-blue-600 bg-blue-50 px-1 rounded">‡∏õ‡∏£‡∏∏‡∏á</span>
                                {% elif item.status == 'SERVED' %}
                                    <span class="text-green-600 bg-green-50 px-1 rounded">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="py-3 px-4 text-center font-medium bg-gray-50/50">x{{ item.quantity }}</td>
                        <td class="py-3 px-4 text-right text-gray-500">{{ item.price|floatformat:0 }}</td>
                        <td class="py-3 px-4 text-right font-bold text-gray-800">{{ item.total|floatformat:0 }}</td>
                        
                        <td class="py-3 px-4 text-center">
                            <form action="{% url 'delete_order_item' item.id %}" method="POST" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ {{ item.menu_name }}?');">
                                {% csrf_token %}
                                <button type="submit" class="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition group-hover:text-red-400" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-20">
                            <div class="flex flex-col items-center justify-center text-gray-300">
                                <span class="text-6xl mb-4">üçΩÔ∏è</span>
                                <span class="text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="bg-gray-50 p-4 border-t text-sm text-gray-600 flex justify-between items-center">
            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <b>{{ order_items|length }}</b></span>
            <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞: <span class="text-green-600 font-bold">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></span>
        </div>
    </div>

    <div class="w-full md:w-96 bg-white rounded-xl shadow-lg flex flex-col h-fit border border-gray-100 overflow-hidden sticky top-6">
        <div class="p-6 bg-linear-to-br from-blue-600 to-indigo-700 text-white relative overflow-hidden">
            <div class="absolute -right-6 -top-6 bg-white opacity-10 rounded-full w-32 h-32"></div>
            
            <h3 class="text-sm opacity-90 mb-1 font-medium tracking-wide">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Grand Total)</h3>
            <div class="text-5xl font-bold tracking-tight">‡∏ø{{ grand_total|floatformat:2 }}</div>
        </div>

        <div class="p-6 space-y-3 border-b border-dashed bg-white">
            <div class="flex justify-between text-gray-600 text-sm">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Subtotal)</span>
                <span class="font-bold text-gray-800">‡∏ø{{ subtotal|floatformat:2 }}</span>
            </div>
            
            {% if restaurant.service_charge_percent > 0 %}
            <div class="flex justify-between text-gray-500 text-xs">
                <span>Service Charge ({{ restaurant.service_charge_percent }}%)</span>
                <span>‡∏ø{{ service_charge_amount|floatformat:2 }}</span>
            </div>
            {% endif %}

            {% if restaurant.vat_percent > 0 %}
            <div class="flex justify-between text-gray-500 text-xs">
                <span>VAT ({{ restaurant.vat_percent }}%)</span>
                <span>‡∏ø{{ vat_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
        </div>

        <div class="p-6 mt-auto bg-gray-50">

            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="clearCustomerScreen()" type="button" 
                    class="flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-3 rounded-xl hover:bg-gray-100 hover:text-red-600 font-bold transition shadow-sm text-sm">
                    üö´ ‡∏õ‡∏¥‡∏î‡∏à‡∏≠
                </button>
                <button onclick="sendToCustomer()" type="button" 
                    class="flex items-center justify-center gap-2 bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-bold shadow-md transition hover:-translate-y-0.5 text-sm">
                    üöÄ ‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                </button>
            </div>
            
            <form method="post" action="{% url 'close_bill' table.id %}" onsubmit="if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ')) { return handleCloseBill(event); } else { return false; }">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="cash" class="peer sr-only" checked>
                            <div class="text-center border rounded-lg p-2 text-gray-600 peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 transition">
                                üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="qr" class="peer sr-only">
                            <div class="text-center border rounded-lg p-2 text-gray-600 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition">
                                üì≤ ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                    ‚úÖ ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞
                </button>
            </form>
            
            <button onclick="window.print()" class="w-full mt-4 text-gray-400 hover:text-gray-600 text-xs py-2 flex items-center justify-center gap-1 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (Receipt)
            </button>
        </div>
    </div>
</div>

<style>
    @media print {
        body * { visibility: hidden; height: 0; overflow: hidden; }
        #printable-area, #printable-area * { visibility: visible; height: auto; overflow: visible; }
        #printable-area { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
    }
</style>

<div id="printable-area" class="hidden print:block p-2 bg-white text-black font-mono text-xs leading-tight">
    <div class="text-center mb-2">
        <h1 class="text-base font-bold">{{ restaurant.name }}</h1>
        <p class="text-[10px]">{{ restaurant.address }}</p>
        <p class="text-[10px]">Tel: {{ restaurant.phone }}</p>
        <div class="border-b border-black border-dashed my-2"></div>
        <div class="flex justify-between">
            <span>‡πÇ‡∏ï‡πä‡∏∞: {{ table.name }}</span>
            <span>{% now "d/m/y H:i" %}</span>
        </div>
    </div>

    <table class="w-full mb-2">
        <thead>
            <tr class="border-b border-black border-dashed">
                <th class="text-left py-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th class="text-right py-1">‡∏£‡∏ß‡∏°</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order_items %}
            <tr>
                <td class="py-1">
                    <div>{{ item.menu_name }}</div>
                    <div class="text-[10px] pl-2 text-gray-600">x{{ item.quantity }} @{{ item.price|floatformat:0 }}</div>
                </td>
                <td class="text-right align-top py-1">{{ item.total|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="border-t border-black border-dashed my-2"></div>

    <div class="flex justify-between">
        <span>‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
        <span>{{ subtotal|floatformat:2 }}</span>
    </div>
    
    {% if restaurant.service_charge_percent > 0 %}
    <div class="flex justify-between">
        <span>S.C. {{ restaurant.service_charge_percent }}%</span>
        <span>{{ service_charge_amount|floatformat:2 }}</span>
    </div>
    {% endif %}

    {% if restaurant.vat_percent > 0 %}
    <div class="flex justify-between">
        <span>VAT {{ restaurant.vat_percent }}%</span>
        <span>{{ vat_amount|floatformat:2 }}</span>
    </div>
    {% endif %}

    <div class="flex justify-between text-lg font-bold mt-2 border-t border-black pt-1">
        <span>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
        <span>{{ grand_total|floatformat:2 }}</span>
    </div>

    <div class="text-center mt-4 text-[10px]">
        <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
        <p class="mt-1">** ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠ **</p>
    </div>
</div>

<div id="raw-order-data" style="display: none;">
    {% for item in order_items %}
    <div 
        data-name="{{ item.menu_name }}" 
        data-quantity="{{ item.quantity }}" 
        data-price="‡∏ø{{ item.total|floatformat:2 }}"
    ></div>
    {% endfor %}
</div>

<script>
    const restaurantId = "{{ restaurant.id|default:'' }}"; 
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/';
    
    let socket = new WebSocket(wsUrl);

    socket.onopen = function () { console.log("‚úÖ WebSocket Connected!"); };
    socket.onerror = function(error) { console.error("‚ùå WebSocket Error:", error); };

    function getOrderItems() {
        const rawElements = document.querySelectorAll('#raw-order-data div');
        return Array.from(rawElements).map(el => ({
            name: el.getAttribute('data-name'),
            quantity: parseInt(el.getAttribute('data-quantity')),
            price: el.getAttribute('data-price')
        }));
    }

    window.sendToCustomer = function() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            alert("‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
            return;
        }
        const items = getOrderItems();
        const grandTotal = "{{ grand_total|floatformat:2 }}";
        socket.send(JSON.stringify({
            command: 'show_customer_payment',
            items: items,
            total: '‡∏ø' + grandTotal
        }));
    };

    window.clearCustomerScreen = function() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ command: 'hide_customer_payment' }));
        }
    };

    window.handleCloseBill = function(event) {
        window.clearCustomerScreen();
        return true;
    };
</script>
{% endblock %}
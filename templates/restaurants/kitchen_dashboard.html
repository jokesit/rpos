{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">üë®‚Äçüç≥ Kitchen Monitor: {{ restaurant.name }}</h1>
    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold flex items-center">
        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
        Live Connection
    </span>
</div>

<div id="order-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    
    {% for order in orders %}
    <div class="bg-white border-l-4 {% if order.status == 'PENDING' %}border-yellow-500{% else %}border-blue-500{% endif %} rounded-lg shadow-md p-4" id="order-{{ order.id }}">
        <div class="flex justify-between items-start mb-2">
            <div>
                <h3 class="font-bold text-xl text-gray-800">‡πÇ‡∏ï‡πä‡∏∞ {{ order.table.name }}</h3>
                <p class="text-xs text-gray-500">#{{ order.id }} ‚Ä¢ {{ order.created_at|date:"H:i" }}</p>
            </div>
            <span class="text-xs font-bold px-2 py-1 rounded text-white 
                {% if order.status == 'PENDING' %}bg-yellow-500{% else %}bg-blue-600{% endif %}">
                {{ order.get_status_display }}
            </span>
        </div>
        
        <div class="space-y-2 my-4 border-t border-b py-2 border-dashed">
            {% for item in order.items.all %}
            <div class="flex justify-between text-sm text-gray-800">
                <span>{{ item.quantity }}x {{ item.menu_item.name }}</span>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-4">
            {% if order.status == 'PENDING' %}
            <button onclick="updateStatus('{{ order.id }}', 'COOKING')" 
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-bold shadow-sm">
                üî• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </button>
            {% elif order.status == 'COOKING' %}
            <button onclick="updateStatus('{{ order.id }}', 'SERVED')" 
                    class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition font-bold shadow-sm">
                ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß / ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}

</div>

<audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<script>
    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)
    function updateStatus(orderId, newStatus) {
        // ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?')) return;

        fetch('/orders/api/update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': '{{ csrf_token }}' // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ @csrf_exempt ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            },
            body: JSON.stringify({
                order_id: orderId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        });
    }

    // 2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
    const restaurantId = "{{ restaurant.id }}";
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const orderSocket = new WebSocket(
        ws_scheme + '://' + window.location.host +
        '/ws/orders/' + restaurantId + '/'
    );

    orderSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("New Order:", data);
        
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        const audio = document.getElementById('notify-sound');
        audio.play().catch(e => console.log("Audio play failed usually due to browser policy", e));

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Card ‡πÉ‡∏´‡∏°‡πà
        const order = data.order;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ HTML
        const itemsHtml = order.items.map(item => 
            `<div class="flex justify-between text-sm text-gray-800"><span>${item}</span></div>`
        ).join('');

        // ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô JS Template String ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Quote ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô JS ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        const newCard = `
            <div class="bg-white border-l-4 border-yellow-500 rounded-lg shadow-md p-4 animate-bounce-once" id="order-${order.id}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">‡πÇ‡∏ï‡πä‡∏∞ ${order.table} <span class="text-red-500 text-xs ml-2 animate-pulse">NEW!</span></h3>
                        <p class="text-xs text-gray-500">#${order.id} ‚Ä¢ ${order.created_at}</p>
                    </div>
                    <span class="text-xs font-bold px-2 py-1 rounded text-white bg-yellow-500">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
                </div>
                <div class="space-y-2 my-4 border-t border-b py-2 border-dashed">
                    ${itemsHtml}
                </div>
                <div class="mt-4">
                    <button onclick="updateStatus('${order.id}', 'COOKING')" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-bold shadow-sm">
                        üî• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                    </button>
                </div>
            </div>
        `;
        
        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
        const container = document.getElementById('order-container');
        container.insertAdjacentHTML('afterbegin', newCard);
    };

    orderSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };
</script>

<style>
    @keyframes bounce-once {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    .animate-bounce-once {
        animation: bounce-once 0.5s ease-in-out;
    }
</style>
{% endblock %}
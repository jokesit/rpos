{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-100 p-6">
    
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                üë®‚Äçüç≥ Kitchen Monitor
                <span id="connection-status" class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700">Connecting...</span>
            </h1>
            <p class="text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß</p>
        </div>
        <div class="text-right">
            <div class="text-4xl font-bold text-blue-600" id="clock">00:00</div>
            <p class="text-xs text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="kitchen-grid">
        
        {% for order in orders %}
        <div class="bg-white rounded-xl shadow-md overflow-hidden border-l-4 
            {% if order.status == 'PENDING' %}border-yellow-500{% else %}border-blue-500{% endif %} 
            flex flex-col animate-fade-in-up">
            
            <div class="p-4 border-b bg-gray-50 flex justify-between items-start">
                <div>
                    <h3 class="font-bold text-xl text-gray-800">‡πÇ‡∏ï‡πä‡∏∞ {{ order.table.name }}</h3>
                    <p class="text-xs text-gray-500">Order #{{ order.id }}</p>
                </div>
                <div class="text-right">
                    <span class="text-sm font-bold text-gray-600">{{ order.created_at|date:"H:i" }}</span>
                    <p class="text-xs text-gray-400" id="timer-{{ order.id }}" data-time="{{ order.created_at|date:'c' }}">
                        ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ 0 ‡∏ô‡∏≤‡∏ó‡∏µ
                    </p>
                </div>
            </div>

            <div class="p-4 flex-1 overflow-y-auto max-h-64">
                <ul class="space-y-3">
                    {% for item in order.items.all %}
                    <li class="flex justify-between items-start pb-2 border-b border-gray-100 last:border-0">
                        <div class="flex gap-2">
                            <span class="font-bold text-lg bg-gray-200 w-8 h-8 flex items-center justify-center rounded-md text-gray-700 shrink-0">
                                {{ item.quantity }}
                            </span>
                            <div>
                                <span class="font-bold text-gray-800 text-lg">{{ item.menu_item.name }}</span>
                                {% if item.note %}
                                    <p class="text-red-500 text-sm font-bold mt-1">‚ö†Ô∏è {{ item.note }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="p-4 bg-gray-50 border-t mt-auto">
                {% if order.status == 'PENDING' %}
                <button onclick="updateStatus('{{ order.id }}', 'COOKING')" 
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />
                    </svg>
                    ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥
                </button>
                {% elif order.status == 'COOKING' %}
                <button onclick="updateStatus('{{ order.id }}', 'SERVED')" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß / ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü
                </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="col-span-full flex flex-col items-center justify-center h-96 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <p class="text-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</p>
            <p class="text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</p>
        </div>
        {% endfor %}
    </div>

</div>

<audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<script>
    // --- 1. Clock & Timer Logic ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    function updateOrderTimers() {
        document.querySelectorAll('[id^="timer-"]').forEach(el => {
            const startTime = new Date(el.dataset.time);
            const now = new Date();
            const diffMs = now - startTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) el.innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏±‡πà‡∏á';
            else el.innerText = `‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ ${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ
            if (diffMins > 15) el.classList.add('text-red-500', 'font-bold');
        });
    }
    setInterval(updateOrderTimers, 60000); 
    updateOrderTimers();

    // --- 2. WebSocket Logic ---
    const restaurantId = "{{ restaurant.id }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    
    function connectWebSocket() {
        const socket = new WebSocket(
            wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/'
        );

        const statusBadge = document.getElementById('connection-status');

        socket.onopen = function() {
            console.log("‚úÖ Kitchen Monitor Connected");
            statusBadge.innerText = "üü¢ Online";
            statusBadge.classList.replace('bg-yellow-100', 'bg-green-100');
            statusBadge.classList.replace('text-yellow-700', 'text-green-700');
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á + ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            if (data.command === 'new_order_alert') {
                playAlert(); 
                setTimeout(() => window.location.reload(), 1000);
            }
            
            // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            if (data.command === 'refresh_tables' || (data.order && data.order.refresh_only)) {
                 window.location.reload();
            }
        };

        socket.onclose = function() {
            console.log("‚ùå Connection lost. Reconnecting...");
            statusBadge.innerText = "üî¥ Offline";
            statusBadge.classList.replace('bg-green-100', 'bg-red-100');
            statusBadge.classList.replace('text-green-700', 'text-red-700');
            setTimeout(connectWebSocket, 3000);
        };
    }

    connectWebSocket();

    // --- 3. Sound Logic ---
    function playAlert() {
        const audio = document.getElementById('alert-sound');
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£ User Interaction ‡∏Å‡πà‡∏≠‡∏ô Browser ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        audio.play().catch(e => console.log("Auto-play blocked, waiting for interaction"));
    }

    // --- 4. API Logic ---
    function updateStatus(orderId, newStatus) {
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?')) return;

        // ‡πÉ‡∏ä‡πâ URL Tag ‡∏Ç‡∏≠‡∏á Django ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ Hardcode path
        fetch('{% url "update_order_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': '{{ csrf_token }}' // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ exempt CSRF
            },
            body: JSON.stringify({
                order_id: orderId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ‡∏£‡∏≠ WebSocket ‡∏™‡∏±‡πà‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á reload ‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ
                // window.location.reload(); 
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(err => alert('Connection Error'));
    }
</script>

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }
</style>
{% endblock %}
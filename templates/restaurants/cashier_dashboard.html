{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">üñ•Ô∏è Cashier / POS</h1>
    <div class="text-sm text-gray-500">
        {{ restaurant.name }}
    </div>
</div>

<div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 sm:gap-4">
    {% for table in tables %}
    <a href="{% url 'table_bill_detail' table.id %}" 
       class="
            relative rounded-xl border-2 transition hover:shadow-md
            p-3 sm:p-4 md:p-6
            {% if table.has_active_order %}
                bg-blue-50 border-blue-500
            {% else %}
                bg-white border-gray-200 opacity-80 hover:opacity-100
            {% endif %}
            ">
        
        <h3 class="font-bold text-gray-700 mb-1 text-sm sm:text-base md:text-lg">{{ table.name }}</h3>
        
        {% if table.has_active_order %}
            <div class="text-blue-600 font-bold text-sm sm:text-base md:text-lg">
                ‡∏ø{{ table.pending_amount }}
            </div>
            <p class="text-[10px] sm:text-xs text-gray-500">{{ table.order_count }} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
            
            <span class="absolute top-2 right-2 flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
            </span>
        {% else %}
            <div class="text-gray-300 font-bold text-sm sm:text-base">‡∏ß‡πà‡∏≤‡∏á</div>
        {% endif %}
    </a>
    {% endfor %}
</div>


<script>
    const restaurantId = "{{ restaurant.id }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
    const socket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/'
    );

    socket.onopen = function() {
        console.log("‚úÖ Cashier Dashboard Connected");
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        if (data.command === 'new_order_alert') {
            console.log("üîî New Order:", data);
            
            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
            // const audio = new Audio('/static/sound/ding.mp3');
            // audio.play();

            // ‡πÅ‡∏™‡∏î‡∏á Notification ‡πÅ‡∏ö‡∏ö Browser (Optional)
            if (Notification.permission === "granted") {
                new Notification("‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà!", { body: `‡πÇ‡∏ï‡πä‡∏∞ ${data.table} ‡∏¢‡∏≠‡∏î ${data.total} ‡∏ö‡∏≤‡∏ó` });
            }

            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            setTimeout(() => {
                window.location.reload();
            }, 1000); // ‡∏´‡∏ô‡πà‡∏ß‡∏á 1 ‡∏ß‡∏¥ ‡πÉ‡∏´‡πâ Server ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
        }
        
        // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏ï‡πä‡∏∞
        if (data.command === 'refresh_tables') {
            window.location.reload();
        }
    };
    
    // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if (Notification.permission !== "denied") {
        Notification.requestPermission();
    }
</script>


{% endblock %}
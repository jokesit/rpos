<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Display - {{ restaurant.name }}</title>
    {% load static tailwind_tags %}
    {% tailwind_css %}

    <style>
        body {
            overflow: hidden;
            background-color: black;
            font-family: 'Prompt', sans-serif; /* ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Font ‡∏™‡∏ß‡∏¢‡πÜ */
        }
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-img {
            transition: opacity 1.5s ease-in-out;
        }
    </style>
</head>

<body class="h-screen w-screen relative text-white font-sans selection:bg-blue-500 selection:text-white">

<div id="screen-idle" class="absolute inset-0 bg-gray-900 z-10 overflow-hidden transition-opacity duration-500">

    <div class="absolute inset-0">
        {% if promo_images %}
            {% for promo in promo_images %}
                <img src="{{ promo.image.url }}"
                     class="slide-img absolute inset-0 w-full h-full object-cover opacity-0"
                     alt="Slide">
            {% endfor %}
        {% else %}
            <div class="absolute inset-0 bg-linear-to-br from-gray-800 to-black"></div>
        {% endif %}
    </div>

    <div class="absolute inset-0 bg-black/40 z-10"></div>

    <div class="absolute inset-0 flex flex-col items-center justify-center z-20 px-4 text-center">

        {% if restaurant.image %}
            <img src="{{ restaurant.image.url }}"
                 class="w-32 h-32 md:w-48 md:h-48 rounded-full border-4 border-white/20 shadow-2xl mb-6 object-cover backdrop-blur-sm bg-white/10" aria-label="res-img">
        {% endif %}

        <h1 class="font-bold tracking-tight leading-tight text-4xl sm:text-5xl md:text-7xl mb-4 drop-shadow-xl text-white">
            {{ restaurant.name }}
        </h1>

        <p class="text-gray-200 text-xl sm:text-2xl md:text-3xl font-light tracking-wide">
            ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö / Welcome
        </p>
    </div>
</div>

<div id="screen-payment" class="hidden absolute inset-0 z-50 bg-white text-gray-800 flex-col fade-in">

    <div class="bg-blue-700 text-white p-6 shadow-md shrink-0 flex justify-between items-center">
        <div>
            <h1 class="font-bold text-3xl md:text-4xl">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <p class="text-blue-200 text-lg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        </div>
        <div class="text-right opacity-80 hidden md:block">
            <div class="text-xl font-bold">{{ restaurant.name }}</div>
        </div>
    </div>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">

        <div class="md:w-1/2 bg-gray-50 overflow-y-auto p-6 md:p-8">
            <table class="w-full text-lg md:text-xl">
                <thead class="border-b-2 border-gray-300 text-gray-500 font-medium">
                    <tr>
                        <th class="text-left py-3 w-[50%]">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th class="text-center py-3 w-[20%]">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="text-right py-3 w-[30%]">‡∏£‡∏ß‡∏°</th>
                    </tr>
                </thead>
                <tbody id="order-items-list" class="divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>

        <div class="md:w-1/2 bg-white flex flex-col items-center justify-center p-8 border-t md:border-t-0 md:border-l shadow-[inset_4px_0_10px_-4px_rgba(0,0,0,0.1)] relative">
            
            <div class="text-center w-full mb-8">
                <p class="text-gray-500 text-xl md:text-2xl uppercase tracking-widest mb-1">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ / Total</p>
                <h2 class="font-bold text-blue-600 text-6xl md:text-8xl tracking-tight leading-none" id="display-total">
                    ‡∏ø0.00
                </h2>
            </div>

            <div class="p-4 bg-white border-4 border-blue-500 rounded-3xl shadow-2xl mb-6 relative group">
                {% if restaurant.payment_qr_image %}
                    <img src="{{ restaurant.payment_qr_image.url }}" 
                         class="w-48 h-48 md:w-64 md:h-64 object-contain transition-transform duration-300 group-hover:scale-105" aria-label="res-img-qr-code">
                {% else %}
                    <div class="w-48 h-48 md:w-64 md:h-64 bg-gray-100 flex flex-col items-center justify-center text-gray-400 rounded-xl">
                        <span class="text-4xl mb-2">üì∑</span>
                        <span>No QR Code</span>
                    </div>
                {% endif %}
                
                <div class="absolute -bottom-4 -right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                    </svg>
                </div>
            </div>

            <div class="text-center animate-pulse">
                <p class="text-xl md:text-2xl font-bold text-gray-800">üì≤ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
                <p class="text-gray-500">Scan QR to Pay</p>
            </div>

        </div>
    </div>
</div>

<div id="connection-status" class="absolute bottom-4 right-4 flex items-center gap-2 bg-black/60 backdrop-blur px-3 py-1.5 rounded-full transition-opacity opacity-0 hover:opacity-100 z-60">
    <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-lg" id="status-dot"></div>
    <span class="text-xs text-gray-300 font-mono" id="status-text">Disconnected</span>
</div>


<script>
    const restaurantId = "{{ restaurant.id }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/';
    
    let socket = null;
    let reconnectInterval = null;

    // --- 1. WebSocket Logic with Auto-Reconnect ---
    function connectWebSocket() {
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            console.log("‚úÖ Connected to Customer Display");
            updateStatus(true);
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("üì© Msg:", data);

            // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å views.py / consumers.py
            if (data.command === 'show_customer_payment') { // ‡πÄ‡∏ä‡πá‡∏Ñ key ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (command ‡∏´‡∏£‡∏∑‡∏≠ type)
                showPaymentScreen(data.items, data.total);
            } 
            else if (data.command === 'hide_customer_payment') {
                // ‚≠ê ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠: ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•
                // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏ö‡∏¥‡∏•‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß (Fade out)
                showIdleScreen();
                setTimeout(() => {
                    window.location.reload(); 
                }, 1000); 
            }
            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Key 'type' ‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Code ‡πÄ‡∏Å‡πà‡∏≤)
            else if (data.type === 'show_customer_payment') {
                showPaymentScreen(data.items, data.total);
            }
            else if (data.type === 'hide_customer_payment') {
                showIdleScreen();
                setTimeout(() => window.location.reload(), 1000);
            }
        };

        socket.onclose = function(e) {
            console.warn("‚ö†Ô∏è Disconnected. Reconnecting...", e.reason);
            updateStatus(false);
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            if (!reconnectInterval) {
                reconnectInterval = setInterval(connectWebSocket, 2000);
            }
        };

        socket.onerror = function(err) {
            console.error("‚ùå Socket Error:", err);
            socket.close();
        };
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    connectWebSocket();


    // --- 2. UI Logic ---
    const screenIdle = document.getElementById('screen-idle');
    const screenPayment = document.getElementById('screen-payment');
    const listBody = document.getElementById('order-items-list');
    const totalDisplay = document.getElementById('display-total');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    function showPaymentScreen(items, total) {
        // 1. ‡∏ã‡πà‡∏≠‡∏ô Slide Show
        screenIdle.classList.add('hidden');
        
        // 2. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
        listBody.innerHTML = '';
        totalDisplay.textContent = total;

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        items.forEach(item => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô String (‡∏°‡∏µ ‡∏ø) ‡∏´‡∏£‡∏∑‡∏≠ Number
            const price = item.price; 
            
            const row = `
                <tr class="group hover:bg-gray-50 transition-colors">
                    <td class="py-3 pr-2 break-words">
                        <div class="font-bold text-gray-800">${item.name}</div>
                    </td>
                    <td class="py-3 px-2 text-center">
                        <span class="inline-block bg-gray-200 text-gray-700 rounded-full px-3 py-1 text-sm font-bold">x${item.quantity}</span>
                    </td>
                    <td class="py-3 pl-2 text-right font-bold text-gray-900">${price}</td>
                </tr>
            `;
            listBody.innerHTML += row;
        });

        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Payment
        screenPayment.classList.remove('hidden');
    }

    function showIdleScreen() {
        screenPayment.classList.add('hidden');
        screenIdle.classList.remove('hidden');
    }

    function updateStatus(isOnline) {
        if (isOnline) {
            statusDot.classList.replace('bg-red-500', 'bg-green-500');
            statusDot.classList.add('shadow-[0_0_10px_#22c55e]');
            statusText.textContent = 'Online';
            statusText.classList.add('text-green-400');
        } else {
            statusDot.classList.replace('bg-green-500', 'bg-red-500');
            statusDot.classList.remove('shadow-[0_0_10px_#22c55e]');
            statusText.textContent = 'Disconnected';
            statusText.classList.remove('text-green-400');
        }
    }


    // --- 3. Slideshow Logic ---
    const slides = document.querySelectorAll('.slide-img');
    let currentSlide = 0;

    function startSlideshow() {
        if (slides.length > 0) {
            slides[0].classList.remove('opacity-0');
            
            if (slides.length > 1) {
                setInterval(() => {
                    // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    slides[currentSlide].classList.add('opacity-0');
                    
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Index
                    currentSlide = (currentSlide + 1) % slides.length;
                    
                    // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    slides[currentSlide].classList.remove('opacity-0');
                }, 6000); // 6 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏û
            }
        }
    }
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Slide ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', startSlideshow);

</script>

</body>
</html>
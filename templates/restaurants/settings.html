{% extends "base.html" %}

{% block content %}
<div class="flex flex-col md:flex-row gap-6">
    
    <aside class="w-full md:w-64 bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-fit shrink-0">
        <div class="text-center mb-6">
            {% if restaurant.image %}
                <img src="{{ restaurant.image.url }}" 
                    alt="{{ restaurant.name }}" 
                    class="w-24 h-24 rounded-full mx-auto mb-3 object-cover border-4 border-blue-50 shadow-md">
            {% else %}
                <div class="w-24 h-24 bg-linear-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center mx-auto mb-3 text-4xl shadow-inner text-blue-500">
                    üè™
                </div>
            {% endif %}
            <h3 class="font-bold text-gray-800 text-lg mt-2">{{ restaurant.name }}</h3>
            <p class="text-xs text-gray-500">Owner Dashboard</p>
        </div>
        <nav class="space-y-1">
            <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 font-bold rounded-lg transition">
                <span>üè†</span> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            </a>
            <a href="{% url 'menu_manage' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>üçΩÔ∏è</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π
            </a>
            <a href="{% url 'table_list' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>üé´</span> ‡πÇ‡∏ï‡πä‡∏∞ & QR Code
            </a>
            <a href="{% url 'kitchen_dashboard' %}" target="_blank" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>üë®‚Äçüç≥</span> ‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß (KDS)
            </a>
            <a href="{% url 'cashier_dashboard' %}" target="_blank" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>üñ•Ô∏è</span> ‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πå (POS)
            </a>
            
            <a href="{% url 'report_sales' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>üìä</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
            </a>
            <div class="border-t my-2"></div>
            <a href="{% url 'restaurant_settings' %}" class="flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg transition">
                <span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            </a>

            <a href="{% url 'customer_display' restaurant.slug %}" target="_blank" onclick="openCustomerWindow(event, this.href)" class="flex items-center gap-3 p-4 bg-purple-600 text-white rounded-xl shadow-lg hover:bg-purple-700 transition transform hover:scale-105 mt-4">
                
                <div class="p-3 bg-white/20 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg">‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏ù‡∏±‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <p class="text-sm text-purple-200">Customer Display Screen</p>
                </div>
            </a>
        </nav>
    </aside>

    <main class="flex-1">
        <div class="max-w-3xl bg-white rounded-xl shadow-sm border border-gray-100 p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="mb-8 flex flex-col items-center sm:flex-row gap-6 p-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                    <div class="shrink-0 relative">
                        {% if restaurant.image %}
                            <img id="image-preview" src="{{ restaurant.image.url }}" class="h-32 w-32 object-cover rounded-lg shadow-md bg-white">
                        {% else %}
                            <img id="image-preview" src="https://via.placeholder.com/150?text=No+Logo" class="h-32 w-32 object-cover rounded-lg shadow-md bg-white opacity-50">
                        {% endif %}
                    </div>
                    
                    <div class="flex-1 w-full text-gray-500">
                        <label class="block text-sm font-bold text-gray-700 mb-2">‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <p class="text-xs text-gray-500 mb-3">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏ô‡∏≤‡∏î 800x800 px (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG)</p>
                        
                        {{ form.image }}
                        
                        {% if form.image.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.image.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
                    {{ form.username }}
                    {% if form.username.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.username.errors.0 }}</p>
                    {% endif %}
                </div>

                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                <div class="space-y-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        {{ form.name }}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            {{ form.phone }}
                        </div>
                        </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                        {{ form.address }}
                    </div>
                </div>

                <div class="mb-8 p-6 bg-blue-50 rounded-xl border border-dashed border-blue-300">
                    <h3 class="font-bold text-gray-700 mb-4">QR Code ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô)</h3>
                    
                    <label for="id_payment_qr_image" class="cursor-pointer group flex flex-col sm:flex-row items-center gap-6 relative">
                        
                        <div class="shrink-0 relative">
                            {% if restaurant.payment_qr_image %}
                                <img id="qr-preview" src="{{ restaurant.payment_qr_image.url }}" class="h-40 w-40 object-contain rounded-lg border-2 border-white shadow-md bg-white group-hover:opacity-80 transition">
                            {% else %}
                                <div id="qr-placeholder" class="h-40 w-40 flex flex-col items-center justify-center bg-white rounded-lg border-2 border-dashed border-gray-300 text-gray-400 group-hover:bg-gray-50 transition">
                                    <span class="text-3xl mb-1">üì∑</span>
                                    <span class="text-xs text-center px-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</span>
                                </div>
                                <img id="qr-preview" class="hidden h-40 w-40 object-contain rounded-lg border-2 border-white shadow-md bg-white">
                            {% endif %}
                            
                            <div class="absolute -bottom-2.5 -right-2.5 bg-blue-600 text-white p-2 rounded-full shadow-lg group-hover:scale-110 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </div>
                        </div>

                        <div class="flex-1 w-full">
                            <span class="block text-sm font-bold text-gray-700 mb-2 group-hover:text-blue-600">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ QR Code</span>
                            <p class="text-xs text-gray-500 mb-3">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
                            
                            {{ form.payment_qr_image }}
                            
                            {% if form.payment_qr_image.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.payment_qr_image.errors.0 }}</p>
                            {% endif %}
                        </div>

                    </label> 
                </div>

                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ)</h3>

                    {{ formset.management_form }}

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                        {% for form in formset %}
                            <div class="hidden">
                                {{ form.id }}
                                {{ form.DELETE }} </div>

                            <div class="relative group w-full aspect-square">
                                
                                <label for="{{ form.image.id_for_label }}" class="cursor-pointer block w-full h-full relative rounded-xl border-2 border-dashed border-gray-300 hover:border-blue-500 overflow-hidden bg-gray-50 transition hover:shadow-md">
                                    
                                    <input type="file" 
                                        name="{{ form.image.html_name }}" 
                                        id="{{ form.image.id_for_label }}" 
                                        accept="image/*"
                                        class="hidden promo-file-input"
                                        data-index="{{ forloop.counter0 }}">

                                    <div class="w-full h-full absolute inset-0 z-10 {% if not form.instance.image %}hidden{% endif %}" id="preview-box-{{ forloop.counter0 }}">
                                        {% if form.instance.image %}
                                            <img src="{{ form.instance.image.url }}" class="w-full h-full object-cover">
                                        {% else %}
                                            <img src="" class="w-full h-full object-cover"> {% endif %}
                                    </div>

                                    <div class="w-full h-full flex flex-col items-center justify-center text-gray-400 group-hover:text-blue-500 transition z-0" id="placeholder-box-{{ forloop.counter0 }}">
                                        <span class="text-3xl mb-1">‚ûï</span>
                                        <span class="text-xs">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</span>
                                    </div>
                                </label>

                                <button type="button" 
                                        onclick="deletePromoImage('{{ forloop.counter0 }}')"
                                        class="absolute top-2 right-2 z-20 bg-red-500 text-white p-1.5 rounded-full shadow-md hover:bg-red-600 transition opacity-0 group-hover:opacity-100 {% if not form.instance.image %}hidden{% endif %}"
                                        id="delete-btn-{{ forloop.counter0 }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                                
                                <div id="deleted-overlay-{{ forloop.counter0 }}" class="hidden absolute inset-0 z-30 bg-red-100/90 flex-col items-center justify-center text-red-600 rounded-xl border-2 border-red-500">
                                    <span class="font-bold text-sm">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏•‡∏ö</span>
                                    <button type="button" onclick="undoDelete('{{ forloop.counter0 }}')" class="mt-1 text-xs underline text-red-800">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                </div>

                            </div>
                        {% endfor %}
                    </div>

                <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô & ‡∏†‡∏≤‡∏©‡∏µ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">VAT (%)</label>
                        {{ form.vat_percent }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Charge (%)</label>
                        {{ form.service_charge_percent }}
                    </div>
                </div>

                <div class="flex justify-end pt-4 border-t">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform active:scale-95">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    function setupImagePreview(inputId, previewId, placeholderId = null) {
        const input = document.getElementById(inputId); 
        const preview = document.getElementById(previewId);
        const placeholder = placeholderId ? document.getElementById(placeholderId) : null;

        if (input) {
            input.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.classList.remove('opacity-50', 'hidden'); 
                        
                        if (placeholder) {
                            placeholder.classList.add('hidden');
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });
        } else {
            // Debug: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏π Console ‡∏ß‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô Error ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
            console.error("‚ùå ‡∏´‡∏≤ Input ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠: " + inputId); 
            console.log("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö forms.py ‡∏ß‡πà‡∏≤‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà");
        }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    // 1. Logo (field: image -> id_image)
    setupImagePreview('id_image', 'image-preview');

    // 2. QR Code (field: payment_qr_image -> id_payment_qr_image)
    setupImagePreview('id_payment_qr_image', 'qr-preview', 'qr-placeholder');


    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå Preview
    document.querySelectorAll('.promo-file-input').forEach(input => {
        input.addEventListener('change', function(e) {
            const index = this.dataset.index;
            const file = e.target.files[0];
            const previewBox = document.getElementById(`preview-box-${index}`);
            const deleteBtn = document.getElementById(`delete-btn-${index}`);
            const imgTag = previewBox.querySelector('img');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    imgTag.src = evt.target.result;
                    previewBox.classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ
                    deleteBtn.classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
                }
                reader.readAsDataURL(file);
            }
        });
    });

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ (‡∏Å‡∏î‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)
    function deletePromoImage(index) {
        // ‡∏´‡∏≤ Elements ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        const previewBox = document.getElementById(`preview-box-${index}`);
        const deleteBtn = document.getElementById(`delete-btn-${index}`);
        const input = document.getElementById(`id_promo_images-${index}-image`);
        const deleteCheckbox = document.getElementById(`id_promo_images-${index}-DELETE`);
        const overlay = document.getElementById(`deleted-overlay-${index}`);

        // ‡∏Å‡∏£‡∏ì‡∏µ A: ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Saved Image)
        if (deleteCheckbox) {
            // ‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà checkbox DELETE ‡∏Ç‡∏≠‡∏á Django
            deleteCheckbox.checked = true;
            // ‡πÇ‡∏ä‡∏ß‡πå Overlay ‡∏ß‡πà‡∏≤ "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏•‡∏ö"
            overlay.classList.remove('hidden');
        } 
        
        // ‡∏Å‡∏£‡∏ì‡∏µ B: ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Save)
        else {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ input file
            input.value = ''; 
            // ‡∏ã‡πà‡∏≠‡∏ô Preview ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå Placeholder
            previewBox.classList.add('hidden');
            previewBox.querySelector('img').src = '';
            deleteBtn.classList.add('hidden');
        }
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö (Undo)
    function undoDelete(index) {
        const deleteCheckbox = document.getElementById(`id_promo_images-${index}-DELETE`);
        const overlay = document.getElementById(`deleted-overlay-${index}`);
        
        if (deleteCheckbox) {
            deleteCheckbox.checked = false; // ‡πÄ‡∏≠‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å
            overlay.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô Overlay
        }
    }
</script>
{% endblock %}
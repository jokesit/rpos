{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="th" class="scroll-smooth"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - {{ restaurant.name }}</title>
    {% tailwind_css %}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        [x-cloak] { display: none !important; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏ô‡∏µ‡πâ) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .search-transition { transition: all 0.3s ease; }

        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏°‡πÉ‡∏ï‡πâ Header ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å */
        .scroll-mt-custom {
            scroll-margin-top: 200px; /* ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á Header ‡∏£‡∏ß‡∏° */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased font-sans">

    <div x-data="foodMenu()" x-init="fetchHistory(); initSearch()" class="pb-24 min-h-screen relative">
        
        <div class="bg-white shadow-md sticky top-0 z-30">
            
            <div class="px-4 py-3 flex justify-between items-center border-b border-gray-100">
                <div>
                    <h1 class="font-bold text-lg text-gray-900 leading-tight">{{ restaurant.name }}</h1>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">‡πÇ‡∏ï‡πä‡∏∞ {{ table.name }}</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button @click="openHistory()" class="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 transition active:scale-95">
                        <div class="relative p-2 bg-gray-100 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                        </div>
                        <span class="text-[9px] font-bold mt-0.5">‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                    </button>

                    <button @click="showCart = true" class="flex flex-col items-center justify-center text-blue-600 transition active:scale-95 relative">
                        <div class="relative p-2 bg-blue-50 rounded-full border border-blue-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                            </svg>
                            <span
                                x-text="cartTotalItems() > 9 ? '9+' : cartTotalItems()"
                                :class="cartTotalItems() > 0
                                    ? 'opacity-100 scale-100'
                                    : 'opacity-0 scale-0 pointer-events-none'"
                                class="
                                    absolute top-0 right-0
                                    translate-x-1/2 -translate-y-1/2
                                    w-5 h-5
                                    bg-red-500 text-white
                                    text-[10px] font-bold
                                    flex items-center justify-center
                                    rounded-full
                                    border-2 border-white
                                    shadow-sm
                                    transition-all duration-200 ease-out">
                            </span>
                        </div>
                        <span class="text-[9px] font-bold mt-0.5">‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                    </button>
                </div>
            </div>

            <div class="px-4 py-2 bg-white">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    
                    <input 
                        x-model="search"
                        type="text" 
                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î, ‡∏ï‡πâ‡∏°‡∏¢‡∏≥...)" 
                        class="block w-full pl-10 pr-10 py-2 border-none rounded-xl bg-gray-100 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition shadow-inner sm:text-sm"
                    >
                    
                    <button x-show="search.length > 0" @click="search = ''" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="flex overflow-x-auto gap-2 px-4 pb-3 pt-1 no-scrollbar bg-white border-b border-gray-100 items-center">
                
                <button 
                    @click="scrollToCategory('all')"
                    :class="activeCategory === 'all' ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-200 shrink-0"
                >
                    ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>

                {% for category in categories %}
                <button 
                    x-show="categoryMatches('{{ category.id }}')"
                    @click="scrollToCategory('cat-{{ category.id }}')"
                    :class="activeCategory === 'cat-{{ category.id }}' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-all duration-200 shrink-0"
                >
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>

        </div>
        <div class="p-4 space-y-8 max-w-2xl mx-auto min-h-[60vh]">
            
            <div x-show="isSearchEmpty()" x-cloak class="text-center py-12">
                <div class="inline-block p-4 rounded-full bg-gray-100 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <p class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                <button @click="search=''" class="text-blue-600 text-sm font-bold mt-2">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            {% for category in categories %}
            <div id="cat-{{ category.id }}" 
                 class="category-section search-transition scroll-mt-custom"
                 x-show="categoryMatches('{{ category.id }}')"
            >
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>
                    {{ category.name }}
                    <span class="text-[10px] text-gray-400 font-normal">({{ category.items.all|length }})</span>
                </h2>
                
                <div class="space-y-3">
                    {% for item in category.items.all %}
                    {% if item.is_available %}
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3 overflow-hidden relative group active:border-blue-200 transition search-transition"
                         x-show="itemMatches('{{ item.name|escapejs }}')"
                         data-category="{{ category.id }}"
                    >
                        <div class="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden shrink-0 border border-gray-50">
                            {% if item.image %}
                                <img src="{{ item.image.url }}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" loading="lazy">
                            {% else %}
                                <div class="w-full h-full flex flex-col items-center justify-center text-gray-300">
                                    <span class="text-[10px]">No Image</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <h3 class="font-bold text-gray-800 leading-tight line-clamp-1 text-base">{{ item.name }}</h3>
                                <p class="text-xs text-gray-500 line-clamp-2 mt-1">{{ item.description }}</p>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="font-bold text-lg text-gray-800">‡∏ø{{ item.price|floatformat:0 }}</span>
                                <button @click="addToCart({{ item.id }}, '{{ item.name|escapejs }}', {{ item.price }})" 
                                        class="bg-gray-900 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow hover:bg-black active:scale-95 transition flex items-center gap-1">
                                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            <div class="text-center text-gray-300 text-xs mt-10 pb-4">Powered by RPOS System</div>
        </div>


        <div x-show="showCart" style="display: none;" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
            <div x-show="showCart" x-transition.opacity @click="showCart = false" class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
            <div x-show="showCart" x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0" x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="translate-y-0" x-transition:leave-end="translate-y-full" class="relative w-full max-w-lg bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col max-h-[85vh]">
                <div class="flex justify-center pt-3 pb-1" @click="showCart = false"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
                <div class="px-6 py-2 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á)</h2>
                    <button @click="showCart = false" class="p-1 bg-gray-100 rounded-full text-gray-500">‚úï</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                    <template x-if="cart.length === 0">
                        <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                            <button @click="showCart = false" class="mt-2 text-blue-600 text-sm font-bold">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                        </div>
                    </template>
                    <template x-for="(item, index) in cart" :key="index">
                        <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <div><p class="font-bold text-gray-800" x-text="item.name"></p><p class="text-xs text-gray-500">‡∏ø<span x-text="item.price"></span></p></div>
                            <div class="flex items-center gap-3 bg-gray-50 p-1 rounded-lg border"><button @click="decreaseQty(index)" class="w-7 h-7 bg-white rounded shadow-sm text-gray-600">-</button><span class="font-bold w-4 text-center text-sm" x-text="item.qty"></span><button @click="increaseQty(index)" class="w-7 h-7 bg-white rounded shadow-sm text-blue-600">+</button></div>
                        </div>
                    </template>
                </div>
                <div class="p-6 bg-white border-t shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                    <div class="flex justify-between mb-4 items-center"><span class="text-gray-500">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="text-2xl font-bold text-blue-600">‡∏ø<span x-text="cartTotalAmount()"></span></span></div>
                    <button @click="submitOrder()" :disabled="cart.length === 0" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition disabled:opacity-50">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                </div>
            </div>
        </div>

        <div x-show="showHistory" style="display: none;" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center">
            <div x-show="showHistory" x-transition.opacity @click="showHistory = false" class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
            <div x-show="showHistory" x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0" x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="translate-y-0" x-transition:leave-end="translate-y-full" class="relative w-full max-w-lg bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="flex justify-center pt-3 pb-1" @click="showHistory = false"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <div><h2 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h2><p class="text-xs text-gray-500">‡πÇ‡∏ï‡πä‡∏∞: {{ table.name }}</p></div>
                    <button @click="fetchHistory()" class="text-blue-600 text-xs font-bold flex items-center gap-1 hover:bg-blue-50 px-2 py-1 rounded">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
                    <template x-if="historyLoading"><div class="text-center py-10 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></template>
                    <template x-if="!historyLoading && historyItems.length === 0"><div class="text-center py-10 text-gray-400 flex flex-col items-center"><span class="text-4xl mb-2">üçΩÔ∏è</span><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p></div></template>
                    <template x-for="(item, index) in historyItems" :key="index">
                        <div class="flex justify-between bg-white border border-gray-100 p-3 rounded-xl shadow-sm">
                            <div class="flex-1"><div class="flex items-start justify-between"><h3 class="font-bold text-gray-800" x-text="item.name"></h3><span class="text-xs text-gray-400" x-text="item.time"></span></div><div class="flex items-center gap-2 mt-1"><span class="text-sm text-gray-600">x<span x-text="item.quantity" class="font-bold"></span></span><span class="text-sm text-gray-400">|</span><span class="text-sm text-gray-600">‡∏ø<span x-text="item.total"></span></span></div></div>
                            <div class="flex items-center pl-3"><span class="px-2 py-1 rounded-lg text-[10px] font-bold border" :class="{'bg-yellow-50 text-yellow-600 border-yellow-100': item.status_code === 'PENDING', 'bg-blue-50 text-blue-600 border-blue-100': item.status_code === 'COOKING', 'bg-green-50 text-green-600 border-green-100': item.status_code === 'SERVED' || item.status_code === 'COMPLETED'}" x-text="item.status"></span></div>
                        </div>
                    </template>
                </div>
                <div class="p-6 bg-gray-900 text-white rounded-t-2xl shadow-lg mt-auto"><div class="flex justify-between items-center"><div><p class="text-gray-400 text-xs uppercase">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p class="text-2xl font-bold">‡∏ø<span x-text="historyTotal"></span></p></div><div class="text-right"><button @click="showHistory = false" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm transition">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div></div></div>
            </div>
        </div>

    </div>

    <script>
        function foodMenu() {
            return {
                showCart: false,
                showHistory: false,
                search: '',
                activeCategory: 'all', // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà
                cart: [],
                historyItems: [],
                historyTotal: 0,
                historyLoading: false,

                initSearch() {
                    this.$watch('search', value => {});
                },
                
                // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                scrollToCategory(catId) {
                    this.activeCategory = catId;
                    
                    if (catId === 'all') {
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà ID ‡∏ô‡∏±‡πâ‡∏ô
                        const element = document.getElementById(catId);
                        if (element) {
                            // ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á scroll-margin-top ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô CSS
                            element.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                },

                itemMatches(itemName) {
                    if (this.search === '') return true;
                    return itemName.toLowerCase().includes(this.search.toLowerCase());
                },
                
                categoryMatches(catId) {
                    if (this.search === '') return true;
                    const items = document.querySelectorAll(`div[data-category="${catId}"]`);
                    for (let item of items) {
                         let name = item.querySelector('h3').innerText; 
                         if (name.toLowerCase().includes(this.search.toLowerCase())) return true;
                    }
                    return false;
                },

                isSearchEmpty() {
                     if (this.search === '') return false;
                     const allItems = document.querySelectorAll('[data-category]');
                     for (let item of allItems) {
                         let name = item.querySelector('h3').innerText;
                         if (name.toLowerCase().includes(this.search.toLowerCase())) return false;
                     }
                     return true;
                },

                // --- Cart Logic ---
                addToCart(id, name, price) {
                    let existingItem = this.cart.find(item => item.id === id);
                    if (existingItem) existingItem.qty++;
                    else this.cart.push({ id: id, name: name, price: price, qty: 1 });
                    if (navigator.vibrate) navigator.vibrate(30);
                },
                increaseQty(index) { this.cart[index].qty++; },
                decreaseQty(index) {
                    if (this.cart[index].qty > 1) this.cart[index].qty--;
                    else if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) this.cart.splice(index, 1);
                },
                cartTotalItems() { return this.cart.reduce((t, i) => t + i.qty, 0); },
                cartTotalAmount() { return this.cart.reduce((t, i) => t + (i.price * i.qty), 0).toFixed(0); },

                submitOrder() {
                    if(this.cart.length === 0) return;
                    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£?')) return;

                    fetch('/orders/api/create/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ table_uuid: '{{ table.uuid }}', cart: this.cart })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                            this.cart = [];
                            this.showCart = false;
                            this.openHistory(); 
                        } else {
                            alert('‚ùå Error: ' + data.error);
                        }
                    })
                    .catch(err => alert('‚ö†Ô∏è Connection Error'));
                },

                // --- History Logic ---
                openHistory() {
                    this.showHistory = true;
                    this.fetchHistory();
                },
                fetchHistory() {
                    this.historyLoading = true;
                    fetch(`/orders/api/history/?table_uuid={{ table.uuid }}`)
                    .then(res => res.json())
                    .then(data => {
                        this.historyLoading = false;
                        if(data.success) {
                            this.historyItems = data.items;
                            this.historyTotal = data.grand_total.toFixed(0);
                        }
                    })
                    .catch(err => {
                        this.historyLoading = false;
                        console.error(err);
                    });
                }
            }
        }
    </script>
</body>
</html>





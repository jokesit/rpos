

=== utils.py ===
import sys
from PIL import Image
from io import BytesIO
from django.core.files.uploadedfile import InMemoryUploadedFile

def compress_image(image_field, max_size=(800, 800)):
    """
    ฟังก์ชันสำหรับย่อขนาดรูปภาพและลดคุณภาพไฟล์เล็กน้อยเพื่อประหยัดพื้นที่
    :param image_field: field รูปภาพจาก model
    :param max_size: ขนาดสูงสุด (กว้าง, สูง) ที่ต้องการ (default 800x800)
    """
    # ถ้าไม่มีรูปภาพส่งมา ให้ข้ามไปเลย
    if not image_field:
        return None

    # เปิดรูปภาพด้วย Pillow
    im = Image.open(image_field)

    # ถ้าเป็นรูป PNG (มีพื้นหลังใส) ต้องแปลงโหมดเป็น RGBA ก่อน (กันเหนียว)
    # ถ้าเป็น JPEG จะเป็น RGB
    if im.mode != 'RGB' and im.format == 'JPEG':
        im = im.convert('RGB')

    # คำนวณและย่อขนาดภาพ (thumbnail จะรักษาสัดส่วนภาพให้เอง ไม่เบี้ยว)
    im.thumbnail(max_size, Image.Resampling.LANCZOS)

    # เตรียม Buffer ในหน่วยความจำเพื่อบันทึกรูปใหม่
    output = BytesIO()

    # ตรวจสอบนามสกุลไฟล์เพื่อบันทึกให้ถูก Format
    if im.format == 'PNG':
        im.save(output, format='PNG', optimize=True)
    elif im.format == 'GIF':
        im.save(output, format='GIF', optimize=True)
    else:
        # กรณีทั่วไป (JPEG) บันทึกเป็น JPEG และลด Quality เหลือ 85% (ตาเปล่าแยกไม่ออก แต่ไฟล์เล็กลงมาก)
        im.save(output, format='JPEG', quality=85)

    output.seek(0)

    # สร้าง InMemoryUploadedFile ใหม่เพื่อส่งกลับไปบันทึก
    return InMemoryUploadedFile(
        output,
        'ImageField',
        "%s.%s" % (image_field.name.split('.')[0], im.format.lower()),
        "image/%s" % im.format.lower(),
        sys.getsizeof(output),
        None
    )


=== manage.py ===
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()



=== merge_files.py ===
import os

# ===== CONFIG =====
PROJECT_DIR = "."   # โฟลเดอร์โปรเจค Django ของคุณ
OUTPUT_PART1 = "django_project_part1.txt"
OUTPUT_PART2 = "django_project_part2.txt"
EXTENSIONS = (".py", ".html")          # ประเภทไฟล์ที่ต้องการรวม
# ==================

all_contents = []

# เดินลูปทุกไฟล์ในโปรเจค
for root, dirs, files in os.walk(PROJECT_DIR):
    # ข้ามโฟลเดอร์ที่ไม่ต้องการ
    skip_dirs = ["venv", "__pycache__", "static", "media", "node_modules", "migrations"]
    if any(s in root for s in skip_dirs):
        continue

    for filename in files:
        if filename.endswith(EXTENSIONS):
            full_path = os.path.join(root, filename)
            rel_path = os.path.relpath(full_path, PROJECT_DIR)

            try:
                with open(full_path, "r", encoding="utf-8") as f:
                    content = f.read()
            except:
                with open(full_path, "r", encoding="latin-1") as f:
                    content = f.read()

            # ใส่ header แสดงชื่อไฟล์ก่อนคัดลอกโค้ด
            block = f"\n\n=== {rel_path} ===\n{content}\n"
            all_contents.append(block)

# รวมทั้งหมดเป็นข้อความก้อนเดียว
full_text = "".join(all_contents)

# แบ่งเป็น 2 ไฟล์ (ครึ่งหนึ่ง)
mid = len(full_text) // 2
part1 = full_text[:mid]
part2 = full_text[mid:]

# เขียนลงไฟล์
with open(OUTPUT_PART1, "w", encoding="utf-8") as f:
    f.write(part1)

with open(OUTPUT_PART2, "w", encoding="utf-8") as f:
    f.write(part2)

print("Done! Created:", OUTPUT_PART1, "and", OUTPUT_PART2)



=== config/asgi.py ===
# config/asgi.py
import os
from django.core.asgi import get_asgi_application
from channels.routing import ProtocolTypeRouter, URLRouter
from channels.auth import AuthMiddlewareStack
import orders.routing # import routing ของเรา

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(
            orders.routing.websocket_urlpatterns
        )
    ),
})


=== config/__init__.py ===



=== config/settings.py ===
from pathlib import Path
import os
import environ

# เริ่มต้น Environ
env = environ.Env(
    # กำหนดค่า Default และชนิดข้อมูล
    DEBUG=(bool, False)
)

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent
environ.Env.read_env(os.path.join(BASE_DIR, '.env'))


# --- Security Configuration ---
SECRET_KEY = env('SECRET_KEY')

# แปลงค่า True/False/on/off จาก .env ให้เป็น Boolean
DEBUG = env('DEBUG')

# แปลง string คั่นด้วยลูกน้ำ ให้เป็น List
ALLOWED_HOSTS = env.list('ALLOWED_HOSTS')


# Application definition

INSTALLED_APPS = [
    'daphne', # ใส่ไว้บนสุดสำหรับ Channels

    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # 3rd Party Apps
    'allauth',
    'allauth.account',
    'allauth.socialaccount', # ถ้าอนาคตอยากให้ login ผ่าน Google/Facebook
    'tailwind',
    'theme',
    'django_browser_reload',

    # My Apps
    'users.apps.UsersConfig',
    'restaurants.apps.RestaurantsConfig',
    'dining.apps.DiningConfig',
    'orders.apps.OrdersConfig',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    
    # ⭐ ใส่ Middleware ของเราตรงนี้ (ลำดับสำคัญ) ⭐
    'users.middleware.MaintenanceModeMiddleware',  # 1. เช็คว่าปิดปรับปรุงไหม (ถ้าปิด คนทั่วไปจะหยุดตรงนี้)
    'users.middleware.ApprovalMiddleware',         # 2. เช็คอนุมัติ
    'users.middleware.AdminIPRestrictMiddleware',  # 3. เช็ค IP Admin

    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',

    # ต้องมี Middleware ของ allauth
    'allauth.account.middleware.AccountMiddleware',

    "django_browser_reload.middleware.BrowserReloadMiddleware",
]

ROOT_URLCONF = 'config.urls'


TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [ BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

# --- Database (ดึงจาก .env) ---
# django-environ จะแปลง DATABASE_URL เป็น Dictionary ให้เองอัตโนมัติ
DATABASES = {
    'default': env.db('DATABASE_URL')
}


# Config การ Authentication
AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'allauth.account.auth_backends.AuthenticationBackend',
]


# Config Allauth Behavior
SITE_ID = 1


# ==================================================
# 10 django-allauth Configuration (Secure & Modern)
# ==================================================

# 1. Login Methods: ใช้ Email + Password เท่านั้น
ACCOUNT_LOGIN_METHODS = {"email"}

# 2. ปิด Login by Code (Magic Link) ถาวร
ACCOUNT_LOGIN_BY_CODE_ENABLED = False

# 3. บังคับใช้ Password
ACCOUNT_LOGIN_BY_PASSWORD_ENABLED = True

# 4. Email Settings
ACCOUNT_UNIQUE_EMAIL = True
ACCOUNT_EMAIL_VERIFICATION = "mandatory" # บังคับยืนยันอีเมลก่อนใช้งาน
ACCOUNT_CONFIRM_EMAIL_ON_GET = True # กดลิงก์แล้วยืนยันเลย (ลดขั้นตอนหน้าเว็บ)

# 5. Username Settings 
ACCOUNT_USER_MODEL_USERNAME_FIELD = "username"
# ACCOUNT_USERNAME_REQUIRED = True

# ไม่ต้องซีเรียสเรื่องตัวเล็กตัวใหญ่
ACCOUNT_PRESERVE_USERNAME_CASING = False

# 6. Signup Fields
ACCOUNT_SIGNUP_FIELDS = [
    "email*", # * ใน new style ไม่ต้องใส่ * แล้ว
    "username*",
    "password1*",
    "password2*",
]


# 7. UX & Security
ACCOUNT_SESSION_REMEMBER = True
ACCOUNT_EMAIL_SUBJECT_PREFIX = "[RPOS System] "
LOGIN_REDIRECT_URL = 'dashboard'
LOGOUT_REDIRECT_URL = '/accounts/login/'

# Model User ของเรา
AUTH_USER_MODEL = 'users.User' 

# --------------------------------------------------
# Email Configuration (Gmail SMTP)
# --------------------------------------------------
# ดึงค่าจาก .env แทนการ Hardcode (ปลอดภัยกว่า)
EMAIL_BACKEND = "django.core.mail.backends.smtp.EmailBackend"
EMAIL_HOST = "smtp.gmail.com"
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = env("EMAIL_HOST_USER") # ดึง user
EMAIL_HOST_PASSWORD = env("EMAIL_AUTHEN") # ดึง app password
DEFAULT_FROM_EMAIL = f"RPOS Admin <{EMAIL_HOST_USER}>"


# --- Channels / Redis ---
ASGI_APPLICATION = 'config.asgi.application'
CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            "hosts": [('127.0.0.1', 6379)],
        },
    },
}


# Password validation
# https://docs.djangoproject.com/en/6.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/6.0/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'Asia/Bangkok'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/6.0/howto/static-files/

STATIC_URL = 'static/'

# URL ที่จะใช้เรียกดูรูปใน browser
MEDIA_URL = '/media/'

# โฟลเดอร์จริงในเครื่องที่จะใช้เก็บไฟล์
MEDIA_ROOT = BASE_DIR / 'media'

ACCOUNT_LOGOUT_ON_GET = False
ACCOUNT_LOGOUT_REDIRECT_URL = 'home'

# Config Tailwind
TAILWIND_APP_NAME = 'theme'

INTERNAL_IPS = [
    "127.0.0.1",
]


# for maintenance
ADMIN_IP_RESTRICTION = env.bool('ADMIN_IP_RESTRICTION', default=False)
ADMIN_ALLOWED_IPS = env.list('ADMIN_ALLOWED_IPS', default=['127.0.0.1'])

# ⭐ เพิ่มบรรทัดนี้ ⭐
MAINTENANCE_MODE = env.bool('MAINTENANCE_MODE', default=False)

# -------


=== config/urls.py ===
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from django.views.generic import TemplateView


urlpatterns = [
    path('', TemplateView.as_view(template_name='home.html'), name='home'),
    path('super-admin/', admin.site.urls),
    # URL ของ Allauth (Login, Logout, Signup, Password Reset)
    path('accounts/', include('allauth.urls')),

    path('users/', include('users.urls')),
    # ทุกอย่างที่เกี่ยวกับร้านค้า ให้ขึ้นต้นด้วย /restaurant/
    path('restaurants/', include('restaurants.urls')),
    path('dining/', include('dining.urls')),
    path('orders/', include('orders.urls')),



    # for auto reload
    path("__reload__/", include("django_browser_reload.urls")),


]


# เพิ่มต่อท้าย urlpatterns
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)


=== config/wsgi.py ===
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()



=== restaurants/models.py ===
from django.db import models
from django.conf import settings # เพื่ออ้างอิง User model
from django.utils.text import slugify
import uuid
import segno
from utils import compress_image

class Restaurant(models.Model):
    # เชื่อมกับ User: ถ้า User ถูกลบ ร้านหายไปด้วย (CASCADE)
    # ใช้ OneToOneField เพราะโจทย์คือ 1 User มี 1 ร้าน (ถ้าอนาคตเปลี่ยนเป็น ForeignKey ก็ได้)
    owner = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='restaurant')
    
    name = models.CharField(max_length=255, verbose_name="ชื่อร้าน")
    
    # field รูปภาพร้านค้า
    image = models.ImageField(upload_to='restaurant_images/', blank=True, null=True, verbose_name="รูปร้านค้า/โลโก้")
    
    # เพิ่มรูป Payment QR Code
    payment_qr_image = models.ImageField(upload_to='payment_qrs/', blank=True, null=True, verbose_name="QR Code รับเงิน (ธนาคาร)")

    # Slug เอาไว้ทำ URL สวยๆ เช่น rpos.com/shop/my-coffee-shop/
    slug = models.SlugField(unique=True, blank=True, null=True) 
    
    address = models.TextField(blank=True, verbose_name="ที่อยู่ร้าน")
    phone = models.CharField(max_length=20, blank=True, verbose_name="เบอร์โทรศัพท์ร้าน")
    
    is_active = models.BooleanField(default=True, verbose_name="เปิดใช้งาน")

    vat_percent = models.DecimalField(max_digits=5, decimal_places=2, default=0.00, verbose_name="VAT %")
    service_charge_percent = models.DecimalField(max_digits=5, decimal_places=2, default=0.00, verbose_name="Service Charge %")
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    

    # for create slug
    def save(self, *args, **kwargs):
        if not self.slug:
            base_slug = slugify(self.name) or str(uuid.uuid4())[:8]
            slug = base_slug
            counter = 1
            # check duplicate
            while Restaurant.objects.filter(slug=slug).exists():
                slug = f"{base_slug}-{counter}"
                counter += 1

            self.slug = slug 

        if self.image:
            try:
                # เรียกใช้ฟังก์ชันจาก utils.py (ขนาด 800x800)
                new_image = compress_image(self.image, max_size=(800, 800))
                if new_image:
                    self.image = new_image
            except Exception as e:
                # กรณี Error (เช่น ไฟล์ไม่ใช่รูป) ให้ข้ามไป ไม่ต้องย่อ
                print(f"Image compression failed: {e}")

        # เพิ่ม Logic ย่อรูป Payment QR
        if self.payment_qr_image:
            try:
                new_image = compress_image(self.payment_qr_image, max_size=(500, 500))
                if new_image:
                    self.payment_qr_image = new_image
            except Exception:
                # กรณี Error (เช่น ไฟล์ไม่ใช่รูป) ให้ข้ามไป ไม่ต้องย่อ
                print(f"Image compression failed: {e}")
            
        super().save(*args, **kwargs)

    def __str__(self):
        return self.name
    


class Table(models.Model):
    restaurant = models.ForeignKey(Restaurant, on_delete=models.CASCADE, related_name='tables')
    name = models.CharField(max_length=50, verbose_name="ชื่อโต๊ะ") # เช่น T1, A1, VIP
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True) # รหัสลับสำหรับ QR Code
    
    # เก็บรูป QR Code (เผื่ออยาก cache ไว้ แต่จริงๆ Gen สดก็ได้)
    # ในที่นี้เราจะ Gen สดตอนเรียกใช้เพื่อประหยัดพื้นที่ DB
    
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['name'] # เรียงตามชื่อโต๊ะ

    def __str__(self):
        return f"{self.restaurant.name} - {self.name}"

    def get_order_url(self):
        # พยายามดึง Domain จาก settings ถ้าไม่มีใช้ localhost
        domain = getattr(settings, 'DOMAIN_URL', 'http://127.0.0.1:8000')
        # ลบ slash ท้าย domain ออกถ้ามี เพื่อความชัวร์
        domain = domain.rstrip('/')
        return f"{domain}/dining/{self.restaurant.slug}/{self.uuid}/"

    def get_qr_image(self):
        # สร้าง QR Code แบบ Base64 เพื่อเอาไปแสดงใน HTML ได้เลย โดยไม่ต้องบันทึกไฟล์
        qr = segno.make_qr(self.get_order_url())
        
        # คืนค่าเป็น Data URI scheme (ใช้ใส่ใน tag <img src="..."> ได้เลย)
        return qr.png_data_uri(scale=10)
    
    # for kill link
    def refresh_uuid(self):
        """เปลี่ยนรหัส UUID ใหม่ เพื่อให้ Link เก่าใช้งานไม่ได้"""
        self.uuid = uuid.uuid4()
        self.save()
    


class Category(models.Model):
    restaurant = models.ForeignKey(Restaurant, on_delete=models.CASCADE, related_name='categories')
    name = models.CharField(max_length=100, verbose_name="ชื่อหมวดหมู่")
    order = models.PositiveIntegerField(default=0, verbose_name="ลำดับการแสดงผล")

    class Meta:
        ordering = ['order', 'name']

    def __str__(self):
        return f"{self.restaurant.name} - {self.name}"

class MenuItem(models.Model):
    category = models.ForeignKey(Category, on_delete=models.CASCADE, related_name='items')
    name = models.CharField(max_length=200, verbose_name="ชื่ออาหาร")
    description = models.TextField(blank=True, verbose_name="รายละเอียด")
    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="ราคา")
    image = models.ImageField(upload_to='menu_images/', blank=True, null=True, verbose_name="รูปภาพ")
    is_available = models.BooleanField(default=True, verbose_name="มีจำหน่าย")
    
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.name
    
    # ⭐ เพิ่ม method save เพื่อย่อรูปอาหาร
    def save(self, *args, **kwargs):
        if self.image:
            try:
                # รูปอาหารเอาขนาด 600x600 พอดีจอมือถือ
                new_image = compress_image(self.image, max_size=(600, 600))
                if new_image:
                    self.image = new_image
            except Exception as e:
                print(f"Menu image compression failed: {e}")
                
        super().save(*args, **kwargs)



# สร้าง Model สำหรับรูปสไลด์โชว์ (Promotion Images)
class RestaurantPromoImage(models.Model):
    restaurant = models.ForeignKey(Restaurant, on_delete=models.CASCADE, related_name='promo_images')
    image = models.ImageField(upload_to='promo_images/', verbose_name="รูปโปรโมชั่น/เมนูแนะนำ")
    created_at = models.DateTimeField(auto_now_add=True)

    def save(self, *args, **kwargs):
        if self.image:
            try:
                # รูปสไลด์โชว์ควรชัดหน่อย เอาสัก 1280x720 หรือ 1920x1080
                new_image = compress_image(self.image, max_size=(1280, 720))
                if new_image:
                    self.image = new_image
            except Exception:
                pass
        super().save(*args, **kwargs)


=== restaurants/__init__.py ===



=== restaurants/apps.py ===
from django.apps import AppConfig


class RestaurantsConfig(AppConfig):
    name = 'restaurants'



=== restaurants/forms.py ===
from django import forms
from .models import Restaurant, Category, MenuItem, RestaurantPromoImage
from users.models import User
from django.forms import inlineformset_factory

class RestaurantForm(forms.ModelForm):
    class Meta:
        model = Restaurant
        fields = ['image', 'payment_qr_image', 'name', 'phone', 'address', 'vat_percent', 'service_charge_percent']
        labels = {
            'name': 'ชื่อร้าน',
            'phone': 'เบอร์โทรศัพท์',
            'address': 'ที่อยู่ร้าน',
            'vat_percent': 'VAT (%)',
            'service_charge_percent': 'Service Charge (%)',
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # วนลูปทุก field เพื่อใส่ class ของ Tailwind ให้สวยงาม
        for field_name, field in self.fields.items():
            field.widget.attrs.update({
                'class': 'w-full px-3 py-2 text-gray-800 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500'
            })
            # ปรับแต่งเพิ่มเติมเฉพาะ field ถ้าต้องการ
            if field_name == 'address':
                field.widget.attrs.update({'rows': 3})



# 2. สร้าง Formset สำหรับรูปสไลด์โชว์

PromoImageFormSet = inlineformset_factory(
    Restaurant, 
    RestaurantPromoImage, 
    fields=['image'], 
    
    # ⭐ จุดสำคัญ: ปรับ extra เป็น 10 เพื่อให้โชว์ช่องว่างรอไว้เลย
    extra=10,    
    max_num=10, 
    
    # ป้องกันไม่ให้สร้างเกิน 10 (ถ้ามีรูปเดิม 2 รูป + extra 10 = 12 Django จะตัดให้เหลือ 10 อัตโนมัติ)
    validate_max=True,
    can_delete=True
)




class CategoryForm(forms.ModelForm):
    class Meta:
        model = Category
        fields = ['name', 'order']
        labels = {'name': 'ชื่อหมวดหมู่', 'order': 'ลำดับ (เลขน้อยขึ้นก่อน)'}
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field in self.fields.values():
            field.widget.attrs.update({'class': 'w-full px-3 text-gray-800 py-2 border border-gray-300 rounded-md'})

class MenuItemForm(forms.ModelForm):
    class Meta:
        model = MenuItem
        fields = ['category', 'name', 'price', 'description', 'image', 'is_available']
        labels = {
            'category': 'หมวดหมู่',
            'name': 'ชื่อเมนู',
            'price': 'ราคา (บาท)',
            'is_available': 'เปิดขายอยู่'
        }

    def __init__(self, *args, **kwargs):
        restaurant = kwargs.pop('restaurant', None) # รับค่า restaurant มากรอง category
        super().__init__(*args, **kwargs)
        
        # ใส่ Tailwind class
        for name, field in self.fields.items():
            if name != 'is_available': # checkbox ไม่ต้อง full width
                field.widget.attrs.update({'class': 'w-full px-3 text-gray-800 py-2 border border-gray-300 rounded-md'})
        
        # กรองให้เลือกได้เฉพาะ Category ของร้านตัวเองเท่านั้น! (สำคัญมาก)
        if restaurant:
            self.fields['category'].queryset = Category.objects.filter(restaurant=restaurant)



# setting form of retaurants
class RestaurantSettingsForm(forms.ModelForm):
    username = forms.CharField(
        label='ชื่อผู้ใช้ (Username)',
        max_length=150,
        required=True,
        help_text='ใช้สำหรับอ้างอิงในระบบ (ต้องไม่ซ้ำกับคนอื่น)'
    )
    class Meta:
        model = Restaurant
        fields = ['image', 'payment_qr_image', 'name', 'address', 'phone', 'vat_percent', 'service_charge_percent']
        labels = {
            'image': 'โลโก้ร้านค้า',
            'payment_qr_image': 'QR Code รับเงิน',
            'name': 'ชื่อร้านค้า',
            'address': 'ที่อยู่',
            'phone': 'เบอร์โทรศัพท์ติดต่อ',
            'vat_percent': 'ภาษีมูลค่าเพิ่ม (VAT %)',
            'service_charge_percent': 'ค่าบริการ (Service Charge %)'
        }
        
        widgets = {
            'address': forms.Textarea(attrs={'rows': 3}),
            
            # Style ของ Logo
            'image': forms.ClearableFileInput(attrs={
                'class': 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100'
            }),
            
            # ⭐ 2. เพิ่ม Style ให้ QR Code (หรือจะซ่อน class='hidden' ก็ได้ถ้าใช้ Label ครอบแล้ว)
            'payment_qr_image': forms.ClearableFileInput(attrs={
                'class': 'hidden' # ซ่อนไว้เพราะเรามี UI สวยๆ ใน HTML แล้ว
            })
        }

    # รับ user เข้ามาเพื่อดึงค่า username ปัจจุบันไปแสดง
    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)
        
        # จัด Style Tailwind ให้ field username
        self.fields['username'].widget.attrs.update({
            'class': 'w-full px-4 py-2 text-gray-400 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition'
        })
        
        # ใส่ค่าเดิมลงไปในช่อง
        if self.user:
            self.fields['username'].initial = self.user.username
        
        # จัด Style ให้ field อื่นๆ
        for name, field in self.fields.items():
            # เพิ่ม payment_qr_image เข้าไปในข้อยกเว้น เพราะเรา style แยกไว้ข้างบนแล้ว
            if name not in ['image', 'payment_qr_image']: 
                field.widget.attrs.update({
                    'class': 'w-full px-4 text-gray-800 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition'
                })

    # ฟังก์ชันตรวจสอบความถูกต้อง (Clean)
    def clean_username(self):
        username = self.cleaned_data['username']
        # เช็คว่าชื่อซ้ำคนอื่นไหม (ยกเว้นตัวเอง)
        if User.objects.filter(username=username).exclude(pk=self.instance.owner.pk).exists():
            raise forms.ValidationError("ชื่อผู้ใช้นี้มีผู้ใช้งานแล้ว กรุณาเปลี่ยนชื่อใหม่")
        return username


=== restaurants/admin.py ===
from django.contrib import admin

# Register your models here.



=== restaurants/tests.py ===
from django.test import TestCase

# Create your tests here.



=== restaurants/urls.py ===
from django.urls import path
from . import views

urlpatterns = [
    # เข้ามาที่ /restaurant/ จะเจอ Dashboard เป็นหน้าแรก
    path('', views.dashboard, name='dashboard'),
    
    # เข้ามาที่ /restaurant/create/ เพื่อสร้างร้าน
    path('create/', views.create_restaurant, name='create_restaurant'),
    # จัดการโต๊ะ
    path('tables/', views.table_list, name='table_list'),
    path('tables/delete/<int:table_id>/', views.delete_table, name='delete_table'),
    # Menu Management
    path('menu/', views.menu_manage, name='menu_manage'),
    path('menu/category/add/', views.add_category, name='add_category'),
    path('menu/item/add/', views.add_menu_item, name='add_menu_item'),
    # Menu Items Edit/Delete
    path('menu/item/edit/<int:item_id>/', views.edit_menu_item, name='edit_menu_item'),
    path('menu/item/delete/<int:item_id>/', views.delete_menu_item, name='delete_menu_item'),
    
    # Category Edit/Delete 
    path('menu/category/edit/<int:category_id>/', views.edit_category, name='edit_category'),
    path('menu/category/delete/<int:category_id>/', views.delete_category, name='delete_category'),

    # kitchen
    path('kitchen/', views.kitchen_dashboard, name='kitchen_dashboard'),
    # for cashier
    path('cashier/', views.cashier_dashboard, name='cashier_dashboard'),
    
    path('cashier/<int:table_id>/bill/', views.table_bill_detail, name='table_bill_detail'),
    path('cashier/<int:table_id>/pay/', views.close_bill, name='close_bill'),

    path('report/', views.report_sales, name='report_sales'),

    path('settings/', views.restaurant_settings, name='restaurant_settings'),

    path('customer-display/<slug:restaurant_slug>/', views.customer_facing_display, name='customer_display'),
    path('cashier/order-item/delete/<int:item_id>/', views.delete_order_item, name='delete_order_item'),

    path('super-admin/', views.superuser_dashboard, name='superuser_dashboard'),
    path('super-admin/toggle-status/<int:restaurant_id>/', views.toggle_restaurant_active, name='toggle_restaurant_active'),
]


=== restaurants/views.py ===
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from .models import Table, Category, MenuItem, Restaurant
from .forms import RestaurantForm, CategoryForm, MenuItemForm, RestaurantSettingsForm, PromoImageFormSet
from django.db.models import Sum, Count
from django.db.models.functions import TruncDate
from decimal import Decimal
from django.utils import timezone
from django.core.exceptions import ObjectDoesNotExist
from channels.layers import get_channel_layer
from asgiref.sync import async_to_sync
from orders.models import OrderItem, Order
from django.contrib.auth.decorators import user_passes_test



@user_passes_test(lambda u: u.is_superuser) # เฉพาะ Superuser เท่านั้น
def superuser_dashboard(request):
    restaurants = Restaurant.objects.all().order_by('-created_at')
    
    context = {
        'restaurants': restaurants,
        'total_count': restaurants.count(),
        'active_count': restaurants.filter(is_active=True).count()
    }
    return render(request, 'superuser/dashboard.html', context)

@user_passes_test(lambda u: u.is_superuser)
def toggle_restaurant_active(request, restaurant_id):
    shop = get_object_or_404(Restaurant, pk=restaurant_id)
    shop.is_active = not shop.is_active # สลับสถานะ
    shop.save()
    
    status_msg = "เปิดใช้งาน" if shop.is_active else "ระงับการใช้งาน"
    messages.success(request, f"ร้าน {shop.name} ถูก {status_msg} แล้ว")
    return redirect('superuser_dashboard')


# for show owner
@login_required
def dashboard(request):
    # เช็คว่าเป็น Superuser หรือไม่?
    if request.user.is_superuser:
        # ถ้าใช่ ให้ไปหน้า Admin Panel ของ Django เลย
        return redirect('/super-admin/')
    
    # 2. เช็คว่า User นี้มีร้านค้าหรือยัง?
    try:
        restaurant = request.user.restaurant
    except ObjectDoesNotExist:
        # ถ้ายังไม่มีร้าน ให้ไปหน้าสร้างร้าน (เดี๋ยวเราสร้าง view นี้ในขั้นตอนต่อไป)
        return redirect('create_restaurant')
    

    today = timezone.now().date()

    # 1. ยอดขายวันนี้ (เฉพาะที่จ่ายเงินแล้ว)
    today_sales = restaurant.orders.filter(
        created_at__date=today, 
        is_paid=True
    ).aggregate(Sum('total_price'))['total_price__sum'] or 0

    # 2. จำนวนออเดอร์วันนี้
    today_orders_count = restaurant.orders.filter(created_at__date=today).count()

    # 3. ออเดอร์ที่รอครัวทำ (Pending/Cooking)
    pending_orders_count = restaurant.orders.filter(
        status__in=['PENDING', 'COOKING']
    ).count()

    # 4. โต๊ะที่กำลังใช้งาน (Active Tables)
    # นับโต๊ะที่มีออเดอร์ค้างชำระ
    active_tables_count = restaurant.tables.filter(
        orders__is_paid=False
    ).exclude(orders__status='CANCELLED').distinct().count()

    # 5. รายการล่าสุด 5 รายการ (Recent Activity)
    recent_orders = restaurant.orders.order_by('-created_at')[:5]

    context = {
        'restaurant': restaurant,
        'today_sales': today_sales,
        'today_orders_count': today_orders_count,
        'pending_orders_count': pending_orders_count,
        'active_tables_count': active_tables_count,
        'recent_orders': recent_orders,
    }
    return render(request, 'restaurants/dashboard.html', context)

@login_required
def create_restaurant(request):
    # ป้องกันคนที่มีร้านแล้ว แอบมาเข้าหน้านี้
    if hasattr(request.user, 'restaurant'):
        return redirect('dashboard')

    if request.method == 'POST':
        form = RestaurantForm(request.POST, request.FILES)
        if form.is_valid():
            restaurant = form.save(commit=False)
            restaurant.owner = request.user
            restaurant.save()
            return redirect('dashboard')
    else:
        form = RestaurantForm()
    
    return render(request, 'restaurants/create.html', {'form': form})

# ------------------ 




# for manage table

@login_required
def table_list(request):
    restaurant = request.user.restaurant
    tables = restaurant.tables.all()
    
    # Logic เพิ่มโต๊ะแบบง่ายๆ ในหน้าเดียวกันเลย
    if request.method == 'POST':
        table_name = request.POST.get('name')
        if table_name:
            Table.objects.create(restaurant=restaurant, name=table_name)
            messages.success(request, f'เพิ่มโต๊ะ {table_name} เรียบร้อยแล้ว')
            return redirect('table_list')
            
    return render(request, 'restaurants/table_list.html', {'tables': tables, 'restaurant': restaurant})

@login_required
def delete_table(request, table_id):
    restaurant = request.user.restaurant
    # ต้องเช็คว่า table_id นี้เป็นของร้านเราจริงๆ (Security Check)
    table = get_object_or_404(Table, id=table_id, restaurant=restaurant)
    
    if request.method == 'POST':
        table.delete()
        messages.success(request, 'ลบโต๊ะเรียบร้อยแล้ว')
        
    return redirect('table_list')

# ----------------


# for create menu

@login_required
def menu_manage(request):
    restaurant = request.user.restaurant
    categories = restaurant.categories.prefetch_related('items').all() # ดึงหมวดหมู่พร้อมรายการอาหาร
    
    return render(request, 'restaurants/menu_manage.html', {
        'restaurant': restaurant,
        'categories': categories
    })

@login_required
def add_category(request):
    restaurant = request.user.restaurant
    if request.method == 'POST':
        form = CategoryForm(request.POST)
        if form.is_valid():
            category = form.save(commit=False)
            category.restaurant = restaurant
            category.save()
            messages.success(request, 'เพิ่มหมวดหมู่สำเร็จ')
            return redirect('menu_manage')
    else:
        form = CategoryForm()
    return render(request, 'restaurants/form_generic.html', {'form': form, 'title': 'เพิ่มหมวดหมู่'})

@login_required
def add_menu_item(request):
    restaurant = request.user.restaurant
    if request.method == 'POST':
        # ส่ง restaurant เข้าไปใน form เพื่อกรอง category
        form = MenuItemForm(request.POST, request.FILES, restaurant=restaurant) 
        if form.is_valid():
            form.save()
            messages.success(request, 'เพิ่มเมนูสำเร็จ')
            return redirect('menu_manage')
    else:
        form = MenuItemForm(restaurant=restaurant)
    return render(request, 'restaurants/form_generic.html', {'form': form, 'title': 'เพิ่มเมนูอาหาร'})


@login_required
def edit_menu_item(request, item_id):
    restaurant = request.user.restaurant
    
    # ดึงเมนู โดยเช็คว่า category ของเมนูนั้น ต้องเป็นของร้านเราจริงๆ
    item = get_object_or_404(MenuItem, id=item_id, category__restaurant=restaurant)
    
    if request.method == 'POST':
        # ส่ง instance=item เข้าไป เพื่อบอกว่านี่คือการ "แก้ไข" ไม่ใช่สร้างใหม่
        form = MenuItemForm(request.POST, request.FILES, instance=item, restaurant=restaurant)
        if form.is_valid():
            form.save()
            messages.success(request, f'แก้ไขเมนู "{item.name}" เรียบร้อยแล้ว')
            return redirect('menu_manage')
    else:
        # โหลดข้อมูลเดิมมาใส่ในฟอร์ม
        form = MenuItemForm(instance=item, restaurant=restaurant)
        
    return render(request, 'restaurants/form_generic.html', {
        'form': form, 
        'title': f'แก้ไขเมนู: {item.name}'
    })


@login_required
def delete_menu_item(request, item_id):
    restaurant = request.user.restaurant
    item = get_object_or_404(MenuItem, id=item_id, category__restaurant=restaurant)
    
    if request.method == 'POST':
        item_name = item.name
        item.delete()
        messages.success(request, f'ลบเมนู "{item_name}" แล้ว')
        
    return redirect('menu_manage')


# (แถม) แก้ไขหมวดหมู่ด้วย เผื่อพิมพ์ผิด
@login_required
def edit_category(request, category_id):
    restaurant = request.user.restaurant
    category = get_object_or_404(Category, id=category_id, restaurant=restaurant)
    
    if request.method == 'POST':
        form = CategoryForm(request.POST, instance=category)
        if form.is_valid():
            form.save()
            messages.success(request, 'แก้ไขหมวดหมู่เรียบร้อย')
            return redirect('menu_manage')
    else:
        form = CategoryForm(instance=category)
        
    return render(request, 'restaurants/form_generic.html', {'form': form, 'title': 'แก้ไขหมวดหมู่'})

@login_required
def delete_category(request, category_id):
    restaurant = request.user.restaurant
    category = get_object_or_404(Category, id=category_id, restaurant=restaurant)
    
    if request.method == 'POST':
        category.delete() # เมนูในหมวดนี้จะหายไปด้วย (Cascade)
        messages.success(request, 'ลบหมวดหมู่เรียบร้อย')
        
    return redirect('menu_manage')

# ----------


# for kitchen

@login_required
def kitchen_dashboard(request):
    restaurant = request.user.restaurant
    # ดึงออเดอร์ที่ยังทำไม่เสร็จ (Pending/Cooking)
    orders = restaurant.orders.filter(status__in=['PENDING', 'COOKING']).order_by('created_at')

    return render(request, 'restaurants/kitchen_dashboard.html', {
        'restaurant': restaurant,
        'orders': orders
    })


# -----------


# for cashier

@login_required
def cashier_dashboard(request):
    restaurant = request.user.restaurant
    tables = restaurant.tables.all()
    
    # ดึงข้อมูลมาแปะใส่ table object ว่าโต๊ะนี้มียอดค้างเท่าไหร่
    for table in tables:
        # หาออเดอร์ที่ยังไม่จ่ายเงิน (is_paid=False) และยังไม่ยกเลิก
        active_orders = table.orders.filter(is_paid=False).exclude(status='CANCELLED')
        
        if active_orders.exists():
            table.has_active_order = True
            table.pending_amount = active_orders.aggregate(Sum('total_price'))['total_price__sum'] or 0
            table.order_count = active_orders.count()
        else:
            table.has_active_order = False
            
    return render(request, 'restaurants/cashier_dashboard.html', {
        'restaurant': restaurant,
        'tables': tables
    })


@login_required
def table_bill_detail(request, table_id):
    restaurant = request.user.restaurant
    table = get_object_or_404(Table, id=table_id, restaurant=restaurant)
    
    # 1. ดึงออเดอร์ที่ยังไม่จ่าย (Active Orders)
    # เราไม่เอาที่ CANCELLED
    active_orders = table.orders.filter(is_paid=False).exclude(status='CANCELLED')
    
    if not active_orders.exists():
        messages.warning(request, 'โต๊ะนี้ไม่มีรายการค้างชำระ')
        return redirect('cashier_dashboard')

    # 2. รวบรวมรายการอาหารทั้งหมด (Order Items) จากทุกออเดอร์
    # เรียงตามเวลาสั่ง (เก่า -> ใหม่)
    order_items = []
    subtotal = Decimal('0.00')
    
    for order in active_orders:
        for item in order.items.select_related('menu_item').all():
            item_total = item.price * item.quantity
            subtotal += item_total
            order_items.append({
                'id': item.id,
                'menu_name': item.menu_item.name,
                'quantity': item.quantity,
                'price': item.price,
                'total': item_total,
                'order_time': order.created_at,
                'status': order.status
            })

    # 3. คำนวณภาษีและ Service Charge
    # แปลงค่า Default 0 ให้เป็น Decimal('0') เพื่อไม่ให้กลายเป็น Float
    service_charge_percent = restaurant.service_charge_percent or Decimal('0')
    vat_percent = restaurant.vat_percent or Decimal('0')
    
    # ใช้ Decimal('100') ในการหาร เพื่อบังคับให้ผลลัพธ์เป็น Decimal เสมอ
    service_charge_amount = subtotal * (service_charge_percent / Decimal('100'))
    
    # รวมยอดก่อน VAT
    after_service = subtotal + service_charge_amount
    
    # คำนวณ VAT
    vat_amount = after_service * (vat_percent / Decimal('100'))
    
    # ยอดสุทธิ
    grand_total = after_service + vat_amount

    context = {
        'restaurant': restaurant,
        'table': table,
        'order_items': order_items,
        'subtotal': subtotal,
        'service_charge_amount': service_charge_amount,
        'vat_amount': vat_amount,
        'grand_total': grand_total,
        'active_orders': active_orders,
    }
    
    return render(request, 'restaurants/bill_detail.html', context)


@login_required
def close_bill(request, table_id):
    if request.method == 'POST':
        restaurant = request.user.restaurant
        table = get_object_or_404(Table, id=table_id, restaurant=restaurant)
        
        # ดึงออเดอร์ที่ยังไม่จ่ายทั้งหมดมาปิด
        active_orders = table.orders.filter(is_paid=False).exclude(status='CANCELLED')
        
        if active_orders.exists():
            # Update ทีเดียวทุก Rows (Bulk Update)
            active_orders.update(
                is_paid=True, 
                status='COMPLETED',
                updated_at=timezone.now()
            )
            
            table.refresh_uuid()
            
            # 2. ⭐ เพิ่มส่วนนี้: ส่งสัญญาณ WebSocket บอกให้หน้ารายการโต๊ะรีเฟรช
            channel_layer = get_channel_layer()
            async_to_sync(channel_layer.group_send)(
                f'restaurant_{table.restaurant.id}',  # ส่งเข้า Group ของร้านนั้นๆ
                {
                    'type': 'table_update_notification', # ชื่อ Event ที่จะไปเขียนใน consumers.py
                    'message': 'Refresh Tables'
                }
            )
            
            messages.success(request, f'รับชำระเงินโต๊ะ {table.name} เรียบร้อยแล้ว')
        
    return redirect('cashier_dashboard')

# ------

# for report
@login_required
def report_sales(request):
    restaurant = request.user.restaurant
    
    # ดึงออเดอร์ที่จ่ายเงินแล้ว (COMPLETED)
    completed_orders = restaurant.orders.filter(status='COMPLETED', is_paid=True)
    
    # 1. ยอดขายวันนี้
    today = timezone.now().date()
    today_sales = completed_orders.filter(created_at__date=today).aggregate(Sum('total_price'))['total_price__sum'] or 0
    
    # 2. ยอดขายย้อนหลัง 7 วัน (Group by Date)
    daily_sales = completed_orders.annotate(date=TruncDate('created_at')) \
        .values('date') \
        .annotate(total=Sum('total_price'), count=Count('id')) \
        .order_by('-date')[:7] # เอาแค่ 7 วันล่าสุด

    return render(request, 'restaurants/report_sales.html', {
        'restaurant': restaurant,
        'today_sales': today_sales,
        'daily_sales': daily_sales
    })

# ----------

# setting

@login_required
def restaurant_settings(request):
    restaurant = request.user.restaurant
    
    if request.method == 'POST':
        # ส่ง request.user ไปให้ Form ด้วย
        form = RestaurantSettingsForm(request.POST, request.FILES, instance=restaurant, user=request.user)
        # รับค่า Formset
        formset = PromoImageFormSet(request.POST, request.FILES, instance=restaurant)
        
        if form.is_valid() and formset.is_valid():
            # 1. บันทึกข้อมูลร้านค้า (Restaurant)
            form.save()
            formset.save() # บันทึกรูปสไลด์
            
            # 2. บันทึกข้อมูล Username (User)
            new_username = form.cleaned_data['username']
            user = request.user
            if user.username != new_username:
                user.username = new_username
                user.save()
            
            messages.success(request, 'บันทึกการตั้งค่าและชื่อผู้ใช้เรียบร้อยแล้ว')
            return redirect('restaurant_settings')
    else:
        # ส่ง request.user ไปให้ Form เพื่อแสดงค่าเริ่มต้น
        form = RestaurantSettingsForm(instance=restaurant, user=request.user)
        formset = PromoImageFormSet(instance=restaurant)
        
    return render(request, 'restaurants/settings.html', {
        'form': form,
        'formset': formset, # ส่งไป template
        'restaurant': restaurant
    })


# -------


@login_required
def customer_facing_display(request, restaurant_slug):
    restaurant = get_object_or_404(Restaurant, slug=restaurant_slug, owner=request.user)
    promo_images = restaurant.promo_images.all().order_by('-created_at')
    return render(request, 'restaurants/customer_display.html', {
        'restaurant': restaurant,
        'promo_images': promo_images,
    })



# delete item in bill
@login_required
def delete_order_item(request, item_id):
    item = get_object_or_404(
        OrderItem,
        pk=item_id,
        order__restaurant__owner=request.user
    )

    order = item.order

    if request.method == 'POST':
        item_total = item.price * item.quantity
        menu_name = item.menu_item.name

        # 1. ลบรายการ
        item.delete()

        # 2. อัปเดตยอดรวมของ Order
        order.total_price -= item_total
        if order.total_price < 0:
            order.total_price = 0
        order.save()

        messages.success(request, f"ลบรายการ {menu_name} เรียบร้อยแล้ว")

    return redirect('table_bill_detail', table_id=order.table.id)


=== theme/__init__.py ===



=== theme/apps.py ===
from django.apps import AppConfig


class ThemeConfig(AppConfig):
    name = 'theme'



=== theme/templates/base.html ===
{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Django Tailwind</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    {% tailwind_css %}
</head>

<body class="bg-gray-50 text-black font-serif leading-normal tracking-normal">

    <div class="toast toast-top toast-end">
        <div class="alert alert-info">
            <span>Hello from daisyUi 👋</span>
        </div>
    </div>

<div class="container mx-auto">
    <section class="flex items-center justify-center h-screen">
        <h1 class="text-5xl">Django + Tailwind = ❤️</h1>
    </section>
</div>
</body>
</html>



=== users/models.py ===
# users/models.py
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    # สถานะการอนุมัติ
    STATUS_CHOICES = [
        ('PENDING', 'รออนุมัติ'),
        ('APPROVED', 'อนุมัติแล้ว'),
        ('REJECTED', 'ไม่อนุมัติ'),
        ('SUSPENDED', 'ระงับการใช้งาน'),
    ]
    email = models.EmailField(unique=True, verbose_name='Email Address')
    
    # User Types (เผื่ออนาคตอยากแยก Role ชัดเจนในระดับ Model)
    is_shop_owner = models.BooleanField(default=False, verbose_name="เป็นเจ้าของร้าน")
    
    approval_status = models.CharField(
        max_length=20, 
        choices=STATUS_CHOICES, 
        default='PENDING',
        verbose_name="สถานะการอนุมัติ"
    )
    
    # เพิ่ม field อื่นๆ ได้ที่นี่ เช่น เบอร์โทร
    phone_number = models.CharField(max_length=15, blank=True, null=True)

    def __str__(self):
        return self.email


=== users/__init__.py ===



=== users/apps.py ===
from django.apps import AppConfig


class UsersConfig(AppConfig):
    name = 'users'



=== users/admin.py ===
# users/admin.py
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

class CustomUserAdmin(UserAdmin):
    model = User
    
    # 1. หน้า List: ให้โชว์คอลัมน์อะไรบ้าง (เพิ่ม approval_status เข้าไปดูง่ายๆ)
    list_display = ['email', 'username', 'approval_status', 'is_shop_owner', 'is_staff', 'is_active']
    
    # 2. หน้า Edit: เพิ่ม Field ใหม่เข้าไปในฟอร์มแก้ไข
    # เราใช้ UserAdmin.fieldsets เดิม แล้วบวก Field ของเราเข้าไปต่อท้าย
    fieldsets = UserAdmin.fieldsets + (
        ('RPOS Additional Info', { # ตั้งชื่อ Section ใหม่
            'fields': ('approval_status', 'is_shop_owner', 'phone_number'),
        }),
    )
    
    # 3. หน้า Add User: เพิ่ม Field ตอนสร้าง User ใหม่ด้วย (ถ้าต้องการ)
    add_fieldsets = UserAdmin.add_fieldsets + (
        (None, {
            'fields': ('email', 'approval_status', 'is_shop_owner', 'phone_number'),
        }),
    )

# Register Model กับ Admin
admin.site.register(User, CustomUserAdmin)


=== users/tests.py ===
from django.test import TestCase

# Create your tests here.



=== users/urls.py ===
from django.urls import path
from . import views


urlpatterns = [
    path('pending-approval/', views.approval_pending, name='approval_pending'),
]


=== users/middleware.py ===
# เพื่อตรวจสอบทุก Request ว่า User คนนี้ได้รับอนุมัติหรือยัง ถ้ายัง ให้ถีบไปหน้า pending-approval ทันที

from django.shortcuts import redirect
from django.urls import reverse
from django.http import HttpResponseForbidden
from django.shortcuts import render
from django.conf import settings
import environ


# อ่านค่า env (เผื่อกรณีไม่ได้อ่านผ่าน settings)
env = environ.Env()


# --- 1. Middleware สำหรับจำกัด IP เข้าหน้า Admin ---
class AdminIPRestrictMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # เช็คว่ากำลังเข้าหน้า Admin หรือไม่
        if request.path.startswith('/super-admin/'):
            
            # เช็คว่าเปิดใช้งานระบบป้องกันไหม (ดึงจาก settings)
            restrict_enabled = getattr(settings, 'ADMIN_IP_RESTRICTION', False)
            
            if restrict_enabled:
                # ดึง IP ของผู้ใช้
                x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
                if x_forwarded_for:
                    ip = x_forwarded_for.split(',')[0]
                else:
                    ip = request.META.get('REMOTE_ADDR')

                # ดึงรายการ IP ที่อนุญาต
                allowed_ips = getattr(settings, 'ADMIN_ALLOWED_IPS', [])

                if ip not in allowed_ips:
                    return HttpResponseForbidden(f"⛔ Access Denied: Your IP ({ip}) is not allowed.")

        return self.get_response(request)
    



# --- 2. Middleware เดิมของคุณ (ตรวจสอบสถานะอนุมัติ) ---
class ApprovalMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # 1. ถ้าไม่ได้ Login ก็ปล่อยผ่าน (ให้ไปหน้า Login/Register ได้)
        if not request.user.is_authenticated:
            return self.get_response(request)

        # 2. ถ้าเป็น Superuser ให้ผ่านตลอด
        if request.user.is_superuser:
            return self.get_response(request)
        
        # เพิ่มเงื่อนไข: ถ้าเป็น URL ของ django_browser_reload ให้ปล่อยผ่านเลย
        if request.path.startswith('/__reload__/'):
             return self.get_response(request)

        # 3. เช็คสถานะอนุมัติ
        if request.user.approval_status != 'APPROVED':
            # รายชื่อ URL ที่ยอมให้เข้าได้แม้ยังไม่อนุมัติ (เช่น หน้า Logout, หน้า Pending เอง)
            allowed_paths = [
                reverse('approval_pending'),
                reverse('account_logout'),
                '/admin/', # (เผื่อไว้)
            ]
            
            # ถ้า path ที่เข้า ไม่ใช่อันที่ยกเว้น -> บังคับ redirect ไปหน้า pending
            if request.path not in allowed_paths:
                return redirect('approval_pending')

        return self.get_response(request)
    


# use when web maintenance
class MaintenanceModeMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # 1. ตรวจสอบว่าเปิดโหมดซ่อมบำรุงหรือไม่? (ค่า Default คือ False)
        maintenance_mode = getattr(settings, 'MAINTENANCE_MODE', False)

        if maintenance_mode:
            # 2. ข้อยกเว้น: ยอมให้ผ่านถ้าเป็น...
            # - เข้าหน้า Admin
            # - เป็น Superuser (เพื่อให้เจ้าของระบบเทสได้)
            # - ไฟล์ Static/Media (เพื่อให้หน้าเว็บแสดงผลสวยงาม)
            
            is_admin_url = request.path.startswith('/super-admin/')
            is_static_url = request.path.startswith(settings.STATIC_URL)
            is_media_url = request.path.startswith(settings.MEDIA_URL)
            
            # ต้องตรวจสอบ request.user ก่อนเรียกใช้ .is_superuser 
            # (ป้องกัน Error กรณี Middleware รันก่อน Authentication)
            is_superuser = request.user.is_authenticated and request.user.is_superuser

            if not (is_admin_url or is_static_url or is_media_url or is_superuser):
                # ถ้าไม่ใช่ข้อยกเว้น -> ส่งหน้า 503 กลับไปทันที
                return render(request, '503.html', status=503)

        return self.get_response(request)


=== users/views.py ===
from django.shortcuts import render


def approval_pending(request):
    return render(request, 'users/approval_pending.html')



=== templates/403.html ===
{% extends "base.html" %}

{% block content %}
<div class="min-h-[70vh] flex flex-col items-center justify-center text-center px-4">
    <div class="text-9xl font-extrabold text-orange-100">403</div>
    
    <div class="absolute mt-[-50px]">
        <div class="bg-orange-100 p-4 rounded-full inline-block mb-4">
            <span class="text-4xl">✋</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ไม่มีสิทธิ์เข้าถึง</h1>
        <p class="text-gray-500 mb-8 max-w-md mx-auto">
            คุณไม่มีสิทธิ์ในการเข้าถึงหน้านี้ <br>
            หากคุณคิดว่านี่เป็นข้อผิดพลาด โปรดติดต่อผู้ดูแลระบบ
        </p>
        
        <a href="{% url 'dashboard' %}" class="px-6 py-3 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600 shadow-lg transition transform hover:-translate-y-1">
            กลับหน้าหลัก
        </a>
    </div>
</div>
{% endblock %}


=== templates/home.html ===
{% extends "base.html" %}

{% block content %}
<div class="min-h-[80vh] flex flex-col justify-center items-center text-center">
    <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-6">
        ระบบจัดการร้านอาหาร <span class="text-blue-600">RPOS</span>
    </h1>
    <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
        เปลี่ยนร้านอาหารของคุณให้ทันสมัย สั่งอาหารผ่าน QR Code ส่งเข้าครัว Real-time 
        และจัดการยอดขายได้ในที่เดียว
    </p>
    
    <div class="flex gap-4">
        {% if user.is_authenticated %}
            <a href="{% url 'dashboard' %}" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-bold hover:bg-blue-700 shadow-lg transition transform hover:-translate-y-1">
                ไปที่แดชบอร์ด
            </a>
        {% else %}
            <a href="{% url 'account_signup' %}" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-bold hover:bg-blue-700 shadow-lg transition transform hover:-translate-y-1">
                สมัครใช้ฟรี
            </a>
            <a href="{% url 'account_login' %}" class="bg-white text-gray-700 border border-gray-300 px-8 py-3 rounded-full text-lg font-bold hover:bg-gray-50 transition">
                เข้าสู่ระบบ
            </a>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-20 text-left">
        <div class="p-6 bg-white rounded-xl shadow-md border-t-4 border-blue-500">
            <div class="text-3xl mb-4">📱</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">QR Ordering</h3>
            <p class="text-gray-600">ลูกค้าสแกนสั่งเองผ่านมือถือ ลดงานพนักงาน ลดความผิดพลาด</p>
        </div>
        <div class="p-6 bg-white rounded-xl shadow-md border-t-4 border-green-500">
            <div class="text-3xl mb-4">👨‍🍳</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Kitchen Display</h3>
            <p class="text-gray-600">จอครัวแจ้งเตือนทันทีที่มีออเดอร์ใหม่ ไม่ต้องเดินส่งกระดาษ</p>
        </div>
        <div class="p-6 bg-white rounded-xl shadow-md border-t-4 border-purple-500">
            <div class="text-3xl mb-4">📊</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Sales Report</h3>
            <p class="text-gray-600">ดูยอดขายรายวัน ย้อนหลัง และวิเคราะห์ข้อมูลได้ง่ายๆ</p>
        </div>
    </div>
</div>
{% endblock %}


=== templates/base.html ===
{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPOS - Restaurant System</title>
    {% tailwind_css %}
</head>
<body class="bg-slate-50 font-sans leading-normal tracking-normal min-h-screen flex flex-col">

    <nav class="bg-white/90 backdrop-blur-md p-4 text-gray-800 shadow-sm sticky top-0 z-50 border-b border-gray-100">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="font-bold text-xl">RPOS System</a>
            <div>
                {% if user.is_authenticated %}
                    <span class="mr-4">สวัสดี, {{ user.email }}</span>
                    {% if user.is_superuser %}
                        <a href="{% url 'superuser_dashboard' %}" class="bg-indigo-900 text-white px-3 py-1 mr-1.5 rounded text-sm font-bold border border-indigo-700 hover:bg-indigo-800 ml-4">
                            🛡️ Admin
                        </a>
                    {% endif %}
            
                    <a href="{% url 'account_logout' %}" class="bg-red-500 text-white hover:bg-red-600 px-3 py-1 rounded transition">
                        Logout
                    </a>
                {% else %}
                    <a href="{% url 'account_login' %}" class="hover:underline">Login</a>
                    <a href="{% url 'account_signup' %}" class="ml-4 bg-white text-blue-600 px-3 py-1 rounded hover:underline">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-4 p-4 flex-1">
        {% if messages %}
            {% for message in messages %}
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </div>

    <footer class="text-center text-gray-400 text-sm py-6">
        &copy; 2025 RPOS System
    </footer>

</body>
</html>


=== templates/500.html ===
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Error (500)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen flex flex-col items-center justify-center text-center px-4">
        <div class="text-9xl font-extrabold text-red-100">500</div>
        
        <div class="absolute mt-[-50px]">
            <div class="bg-red-100 p-4 rounded-full inline-block mb-4">
                <span class="text-4xl">🛠️</span>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบเกิดข้อผิดพลาด</h1>
            <p class="text-gray-500 mb-8 max-w-md mx-auto">
                ขออภัยในความไม่สะดวก ทางเราได้รับรายงานปัญหานี้แล้ว <br>
                ทีมงานกำลังเร่งตรวจสอบและแก้ไขโดยเร็วที่สุด
            </p>
            
            <a href="/" class="px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg transition transform hover:-translate-y-1">
                ลองใหม่อีกครั้ง
            </a>
        </div>
    </div>
</body>
</html>


=== templates/404.html ===
{% extends "base.html" %}

{% block content %}
<div class="min-h-[70vh] flex flex-col items-center justify-center text-center px-4">
    <div class="text-9xl font-extrabold text-gray-200">404</div>
    
    <div class="absolute mt-[-50px]">
        <div class="bg-blue-100 p-4 rounded-full inline-block mb-4">
            <span class="text-4xl">🤔</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">หาหน้านี้ไม่เจอ</h1>
        <p class="text-gray-500 mb-8 max-w-md mx-auto">
            ขออภัย เราไม่พบหน้าที่คุณกำลังค้นหา <br>
            ลิงก์อาจถูกย้าย หรือคุณอาจพิมพ์ URL ผิด
        </p>
        
        <div class="flex gap-4 justify-center">
            <a href="javascript:history.back()" class="px-6 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition">
                &larr; ย้อนกลับ
            </a>
            <a href="{% url 'home' %}" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg transition transform hover:-translate-y-1">
                ไปหน้าหลัก
            </a>
        </div>
    </div>
</div>
{% endblock %}


=== templates/503.html ===
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ปิดปรับปรุงชั่วคราว (Maintenance Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans text-gray-600">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center border border-gray-100">
            <div class="w-20 h-20 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-4xl">🚧</span>
            </div>
            
            <h1 class="text-2xl font-bold text-gray-800 mb-3">ระบบปิดปรับปรุงชั่วคราว</h1>
            
            <p class="mb-6 leading-relaxed">
                เรากำลังอัปเกรดระบบเพื่อประสิทธิภาพที่ดียิ่งขึ้น <br>
                กรุณารอสักครู่ แล้วกลับมาใหม่อีกครั้ง
            </p>
            
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6 overflow-hidden">
                <div class="bg-yellow-400 h-2.5 rounded-full animate-pulse" style="width: 75%"></div>
            </div>
            
            <div class="text-sm text-gray-400">
                &copy; RPOS System Team
            </div>
        </div>
    </div>
</body>
</html>


=== templates/restaurants/customer_display.html ===
{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Customer Display - {{ restaurant.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <style>
        body { overflow: hidden; background-color: black; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Transition สำหรับรูปภาพ */
        .slide-img {
            transition: opacity 1.5s ease-in-out;
        }
    </style>
</head>
<body class="h-screen w-screen relative text-white font-sans">

    <div id="screen-idle" class="absolute inset-0 bg-gray-900 z-10 overflow-hidden">
        
        <div id="slideshow-container" class="absolute inset-0 w-full h-full">
            {% if promo_images %}
                {% for promo in promo_images %}
                    <img src="{{ promo.image.url }}" 
                         class="slide-img absolute inset-0 w-full h-full object-cover opacity-0"
                         alt="Menu Slide">
                {% endfor %}
            {% else %}
                <div class="absolute inset-0 bg-linear-to-br from-gray-800 to-gray-900"></div>
            {% endif %}
        </div>

        <div class="absolute inset-0 bg-black/40 z-10"></div>

        <div class="absolute inset-0 flex flex-col items-center justify-center z-20">
            {% if restaurant.image %}
                <img src="{{ restaurant.image.url }}" class="w-32 h-32 rounded-full border-4 border-white shadow-lg mb-6 object-cover">
            {% endif %}
            
            <h1 class="text-6xl font-bold mb-4 text-white drop-shadow-lg tracking-wide">{{ restaurant.name }}</h1>
            <p class="text-3xl text-gray-200 drop-shadow-md">ยินดีต้อนรับ / Welcome</p>
        </div>
    </div>

    <div id="screen-payment" class="hidden absolute inset-0 z-50 bg-white text-gray-800 flex-col fade-in">
        <div class="bg-blue-600 text-white p-6 shadow-md flex justify-between items-center">
            <h1 class="text-4xl font-bold">สรุปรายการชำระเงิน</h1>
            <div class="text-xl opacity-80">{{ restaurant.name }}</div>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <div class="w-1/2 p-8 bg-gray-50 overflow-y-auto">
                <table class="w-full text-2xl">
                    <thead class="border-b-2 border-gray-300 text-gray-500">
                        <tr>
                            <th class="text-left py-4">รายการ</th>
                            <th class="text-center py-4">จำนวน</th>
                            <th class="text-right py-4">ราคา</th>
                        </tr>
                    </thead>
                    <tbody id="order-items-list">
                        </tbody>
                </table>
            </div>

            <div class="w-1/2 p-8 flex flex-col items-center justify-center bg-white border-l shadow-inner relative">
                <div class="text-center mb-10 w-full">
                    <p class="text-gray-500 text-2xl">ยอดสุทธิ / Total</p>
                    <h2 class="text-8xl font-bold text-blue-600 mt-2" id="display-total">฿0.00</h2>
                </div>

                <div class="p-4 border-4 border-blue-500 rounded-3xl mb-6 shadow-xl bg-white">
                     {% if restaurant.payment_qr_image %}
                        <img src="{{ restaurant.payment_qr_image.url }}" class="w-72 h-72 object-contain">
                    {% else %}
                        <div class="w-72 h-72 bg-gray-100 flex flex-col items-center justify-center text-gray-400 rounded-xl">
                            <span class="text-4xl mb-2">📷</span>
                            <span>No QR Code</span>
                        </div>
                    {% endif %}
                </div>
                <p class="text-2xl font-bold text-gray-700 animate-pulse">📲 Scan to Pay</p>
            </div>
        </div>
    </div>

    <script>
        // --- 1. WebSocket Logic ---
        const restaurantId = "{{ restaurant.id }}";
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        
        console.log("Connecting to Display Socket...");
        const socket = new WebSocket(
            wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/'
        );

        socket.onopen = function() {
            console.log("✅ Display Screen Connected!");
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === 'show_customer_payment') {
                showPaymentScreen(data.items, data.total);
            } 
            else if (data.type === 'hide_customer_payment') {
                showIdleScreen();
            }
        };

        socket.onclose = function() {
            console.error("Connection lost. Reconnecting in 3s...");
            setTimeout(() => location.reload(), 3000);
        };

        // --- 2. Slideshow Logic ---
        const slides = document.querySelectorAll('.slide-img');
        let currentSlide = 0;

        function startSlideshow() {
            if (slides.length > 0) {
                // โชว์รูปแรกก่อนเลย
                slides[0].classList.remove('opacity-0');

                if (slides.length > 1) {
                    setInterval(() => {
                        // ซ่อนรูปปัจจุบัน
                        slides[currentSlide].classList.add('opacity-0');
                        
                        // คำนวณ Index รูปถัดไป
                        currentSlide = (currentSlide + 1) % slides.length;
                        
                        // โชว์รูปถัดไป
                        slides[currentSlide].classList.remove('opacity-0');
                    }, 5000); // เปลี่ยนทุก 5 วินาที
                }
            }
        }
        
        // เริ่มต้น Slideshow ทันทีที่โหลดหน้าเว็บ
        startSlideshow();

        // --- 3. UI Functions ---
        const screenIdle = document.getElementById('screen-idle');
        const screenPayment = document.getElementById('screen-payment');
        const listBody = document.getElementById('order-items-list');
        const totalDisplay = document.getElementById('display-total');

        function showPaymentScreen(items, total) {
            screenIdle.classList.add('hidden');
            screenPayment.classList.remove('hidden'); // แสดงหน้า Payment
            
            // ใส่ข้อมูล
            totalDisplay.textContent = total;
            listBody.innerHTML = '';
            items.forEach(item => {
                const row = `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                        <td class="py-4 font-bold text-gray-700">${item.name}</td>
                        <td class="py-4 text-center text-gray-600">x${item.quantity}</td>
                        <td class="py-4 text-right font-medium text-gray-800">${item.price}</td>
                    </tr>
                `;
                listBody.innerHTML += row;
            });
        }

        function showIdleScreen() {
            screenPayment.classList.add('hidden'); // ซ่อนหน้า Payment
            screenIdle.classList.remove('hidden'); // กลับไปหน้า Slide
        }
    </script>
</body>
</html>


=== templates/restaurants/table_list.html ===
{% extends "base.html" %}

{% block content %}
<div class="flex flex-col md:flex-row gap-6">
    <aside class="w-full md:w-64 bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-fit shrink-0">
        <div class="text-center mb-6">
            {% if restaurant.image %}
                <img src="{{ restaurant.image.url }}" 
                    alt="{{ restaurant.name }}" 
                    class="w-24 h-24 rounded-full mx-auto mb-3 object-cover border-4 border-blue-50 shadow-md">
            {% else %}
                <div class="w-24 h-24 bg-linear-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center mx-auto mb-3 text-4xl shadow-inner text-blue-500">
                    🏪
                </div>
            {% endif %}
            <h3 class="font-bold text-gray-800 text-lg mt-2">{{ restaurant.name }}</h3>
            <p class="text-xs text-gray-500">Owner Dashboard</p>
        </div>
        <nav class="space-y-1">
            <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 font-bold rounded-lg transition">
                <span>🏠</span> ภาพรวม
            </a>
            <a href="{% url 'menu_manage' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>🍽️</span> จัดการเมนู
            </a>
            <a href="{% url 'table_list' %}" class="flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg transition">
                <span>🎫</span> โต๊ะ & QR Code
            </a>
            <a href="{% url 'kitchen_dashboard' %}" target="_blank" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>👨‍🍳</span> จอครัว (KDS)
            </a>
            <a href="{% url 'cashier_dashboard' %}" target="_blank" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>🖥️</span> แคชเชียร์ (POS)
            </a>
            
            <a href="{% url 'report_sales' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>📊</span> รายงานยอดขาย
            </a>
            <div class="border-t my-2"></div>
            <a href="{% url 'restaurant_settings' %}" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                <span>⚙️</span> ตั้งค่าร้านค้า
            </a>

            <a href="{% url 'customer_display' restaurant.slug %}" target="_blank" onclick="openCustomerWindow(event, this.href)" class="flex items-center gap-3 p-4 bg-purple-600 text-white rounded-xl shadow-lg hover:bg-purple-700 transition transform hover:scale-105 mt-4">
                
                <div class="p-3 bg-white/20 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg">เปิดจอฝั่งลูกค้า</h3>
                    <p class="text-sm text-purple-200">Customer Display Screen</p>
                </div>
            </a>
        </nav>
    </aside>

    <main class="flex-1">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">จัดการโต๊ะอาหาร</h2>
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <form method="post" class="flex gap-4">
                {% csrf_token %}
                <input type="text" name="name" placeholder="ชื่อโต๊ะ (เช่น T1, โซน A-1)" class="flex-1 px-4 py-2 text-gray-800 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold">
                    + เพิ่มโต๊ะ
                </button>
            </form>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for table in tables %}
            <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition">
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold text-gray-800">{{ table.name }}</h3>
                    <form method="post" action="{% url 'delete_table' table.id %}" onsubmit="return confirm('ยืนยันที่จะลบโต๊ะนี้?');">
                        {% csrf_token %}
                        <button type="submit" class="text-red-500 hover:text-red-700 text-sm">ลบ</button>
                    </form>
                </div>
                
                <div class="mt-4 flex justify-center">
                    <img src="{{ table.get_qr_image }}" alt="QR Code {{ table.name }}" class="w-40 h-40 border p-2">
                </div>
                
                <div class="mt-4 text-center">
                    <p class="text-xs text-gray-400 mb-2">Scan เพื่อสั่งอาหาร</p>
                    <a href="{{ table.get_order_url }}" target="_blank" class="text-blue-600 hover:underline text-sm">
                        ทดสอบลิ้งค์
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-10 text-gray-500">
                ยังไม่มีโต๊ะอาหาร เริ่มต้นด้วยการเพิ่มโต๊ะแรกของคุณ
            </div>
            {% endfor %}
        </div>
    </main>
</div>


<script>
    const restaurantId = "{{ restaurant.id }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    
    // เชื่อมต่อ WebSocket ช่องเดียวกับที่ใช้ในร้าน
    const socket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/'
    );

    socket.onopen = function() {
        console.log("✅ Table Management Connected to WebSocket");
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        // ⭐ ถ้าได้รับคำสั่ง 'refresh_tables' ให้รีเฟรชหน้าจอทันที
        if (data.command === 'refresh_tables') {
            console.log("♻️ Table updated! Refreshing page...");
            window.location.reload(); 
        }
    };
    
    // Auto Reconnect (กันเหนียว)
    socket.onclose = function() {
        console.log("WebSocket closed. Reconnecting...");
        setTimeout(() => location.reload(), 5000);
    };
</script>

{% endblock %}


=== templates/restaurants/kitchen_dashboard.html ===
{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">👨‍🍳 Kitchen Monitor: {{ restaurant.name }}</h1>
    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold flex items-center">
        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
        Live Connection
    </span>
</div>

<div id="order-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    
    {% for order in orders %}
    <div class="bg-white border-l-4 {% if order.status == 'PENDING' %}border-yellow-500{% else %}border-blue-500{% endif %} rounded-lg shadow-md p-4" id="order-{{ order.id }}">
        <div class="flex justify-between items-start mb-2">
            <div>
                <h3 class="font-bold text-xl text-gray-800">โต๊ะ {{ order.table.name }}</h3>
                <p class="text-xs text-gray-500">#{{ order.id }} • {{ order.created_at|date:"H:i" }}</p>
            </div>
            <span class="text-xs font-bold px-2 py-1 rounded text-white 
                {% if order.status == 'PENDING' %}bg-yellow-500{% else %}bg-blue-600{% endif %}">
                {{ order.get_status_display }}
            </span>
        </div>
        
        <div class="space-y-2 my-4 border-t border-b py-2 border-dashed">
            {% for item in order.items.all %}
            <div class="flex justify-between text-sm text-gray-800">
                <span>{{ item.quantity }}x {{ item.menu_item.name }}</span>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-4">
            {% if order.status == 'PENDING' %}
            <button onclick="updateStatus('{{ order.id }}', 'COOKING')" 
                    class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-bold shadow-sm">
                🔥 เริ่มทำอาหาร
            </button>
            {% elif order.status == 'COOKING' %}
            <button onclick="updateStatus('{{ order.id }}', 'SERVED')" 
                    class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition font-bold shadow-sm">
                ✅ เสร็จแล้ว / พร้อมเสิร์ฟ
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}

</div>

<audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<script>
    // 1. ฟังก์ชันอัปเดตสถานะ (เรียกใช้เมื่อกดปุ่ม)
    function updateStatus(orderId, newStatus) {
        // ถามยืนยันเพื่อกันมือลั่น
        if(!confirm('ยืนยันเปลี่ยนสถานะ?')) return;

        fetch('/orders/api/update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': '{{ csrf_token }}' // ถ้าไม่ได้ใช้ @csrf_exempt ต้องเปิดบรรทัดนี้
            },
            body: JSON.stringify({
                order_id: orderId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ถ้าย้ายสถานะสำเร็จ ให้รีโหลดหน้า
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
        });
    }

    // 2. เชื่อมต่อ WebSocket
    const restaurantId = "{{ restaurant.id }}";
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const orderSocket = new WebSocket(
        ws_scheme + '://' + window.location.host +
        '/ws/orders/' + restaurantId + '/'
    );

    orderSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("New Order:", data);
        
        // เล่นเสียงแจ้งเตือน
        const audio = document.getElementById('notify-sound');
        audio.play().catch(e => console.log("Audio play failed usually due to browser policy", e));

        // สร้าง HTML Card ใหม่
        const order = data.order;
        
        // สร้างรายการอาหาร HTML
        const itemsHtml = order.items.map(item => 
            `<div class="flex justify-between text-sm text-gray-800"><span>${item}</span></div>`
        ).join('');

        // ในส่วน JS Template String นี้เราไม่ต้องใส่ Quote เพราะมันเป็น JS อยู่แล้ว
        const newCard = `
            <div class="bg-white border-l-4 border-yellow-500 rounded-lg shadow-md p-4 animate-bounce-once" id="order-${order.id}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">โต๊ะ ${order.table} <span class="text-red-500 text-xs ml-2 animate-pulse">NEW!</span></h3>
                        <p class="text-xs text-gray-500">#${order.id} • ${order.created_at}</p>
                    </div>
                    <span class="text-xs font-bold px-2 py-1 rounded text-white bg-yellow-500">รอรับออเดอร์</span>
                </div>
                <div class="space-y-2 my-4 border-t border-b py-2 border-dashed">
                    ${itemsHtml}
                </div>
                <div class="mt-4">
                    <button onclick="updateStatus('${order.id}', 'COOKING')" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-bold shadow-sm">
                        🔥 เริ่มทำอาหาร
                    </button>
                </div>
            </div>
        `;
        
        // แทรกการ์ดใหม่ไปไว้ตัวแรกสุด
        const container = document.getElementById('order-container');
        container.insertAdjacentHTML('afterbegin', newCard);
    };

    orderSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };
</script>

<style>
    @keyframes bounce-once {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    .animate-bounce-once {
        animation: bounce-once 0.5s ease-in-out;
    }
</style>
{% endblock %}


=== templates/restaurants/bill_detail.html ===
{% extends "base.html" %}

{% block content %}
<div class="h-[calc(100vh-100px)] flex flex-col md:flex-row gap-6">
    
    <div class="flex-1 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col border border-gray-100">
        <div class="p-5 bg-gray-50 border-b flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    🍽️ รายการอาหาร
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-normal">
                        {{ order_items|length }} รายการ
                    </span>
                </h2>
                <p class="text-sm text-gray-500 mt-1">โต๊ะ: <span class="font-bold text-gray-700">{{ table.name }}</span></p>
            </div>
            <a href="{% url 'cashier_dashboard' %}" class="flex items-center gap-1 text-gray-500 hover:text-blue-600 transition font-medium text-sm bg-white border px-3 py-1.5 rounded-lg shadow-sm hover:shadow">
                &larr; กลับหน้าหลัก
            </a>
        </div>
        
        <div class="flex-1 overflow-y-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 text-gray-500 text-sm uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="py-3 px-4 font-semibold w-12 text-center">#</th>
                        <th class="py-3 px-4 font-semibold">รายการ</th>
                        <th class="py-3 px-4 font-semibold text-center">จำนวน</th>
                        <th class="py-3 px-4 font-semibold text-right">ราคา</th>
                        <th class="py-3 px-4 font-semibold text-right">รวม</th>
                        <th class="py-3 px-4 font-semibold text-center w-16">ลบ</th> </tr>
                </thead>
                <tbody class="text-gray-700 divide-y divide-gray-100">
                    {% for item in order_items %}
                    <tr class="hover:bg-blue-50/50 transition duration-150 group">
                        <td class="py-3 px-4 text-center text-gray-400 text-xs">{{ forloop.counter }}</td>
                        <td class="py-3 px-4">
                            <div class="font-bold text-gray-800">{{ item.menu_name }}</div>
                            <div class="text-xs text-gray-400 mt-0.5 flex items-center gap-1">
                                🕒 {{ item.order_time|date:"H:i" }}
                                {% if item.status == 'PENDING' %}
                                    <span class="text-yellow-600 bg-yellow-50 px-1 rounded">รอ</span>
                                {% elif item.status == 'COOKING' %}
                                    <span class="text-blue-600 bg-blue-50 px-1 rounded">ปรุง</span>
                                {% elif item.status == 'SERVED' %}
                                    <span class="text-green-600 bg-green-50 px-1 rounded">เสิร์ฟ</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="py-3 px-4 text-center font-medium bg-gray-50/50">x{{ item.quantity }}</td>
                        <td class="py-3 px-4 text-right text-gray-500">{{ item.price|floatformat:0 }}</td>
                        <td class="py-3 px-4 text-right font-bold text-gray-800">{{ item.total|floatformat:0 }}</td>
                        
                        <td class="py-3 px-4 text-center">
                            <form action="{% url 'delete_order_item' item.id %}" method="POST" onsubmit="return confirm('ยืนยันลบรายการ {{ item.menu_name }}?');">
                                {% csrf_token %}
                                <button type="submit" class="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition group-hover:text-red-400" title="ลบรายการนี้">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-20">
                            <div class="flex flex-col items-center justify-center text-gray-300">
                                <span class="text-6xl mb-4">🍽️</span>
                                <span class="text-lg">ยังไม่มีรายการอาหาร</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="bg-gray-50 p-4 border-t text-sm text-gray-600 flex justify-between items-center">
            <span>จำนวนรายการ: <b>{{ order_items|length }}</b></span>
            <span>สถานะโต๊ะ: <span class="text-green-600 font-bold">เปิดใช้งาน</span></span>
        </div>
    </div>

    <div class="w-full md:w-96 bg-white rounded-xl shadow-lg flex flex-col h-fit border border-gray-100 overflow-hidden sticky top-6">
        <div class="p-6 bg-linear-to-br from-blue-600 to-indigo-700 text-white relative overflow-hidden">
            <div class="absolute -right-6 -top-6 bg-white opacity-10 rounded-full w-32 h-32"></div>
            
            <h3 class="text-sm opacity-90 mb-1 font-medium tracking-wide">ยอดสุทธิ (Grand Total)</h3>
            <div class="text-5xl font-bold tracking-tight">฿{{ grand_total|floatformat:2 }}</div>
        </div>

        <div class="p-6 space-y-3 border-b border-dashed bg-white">
            <div class="flex justify-between text-gray-600 text-sm">
                <span>ยอดรวมสินค้า (Subtotal)</span>
                <span class="font-bold text-gray-800">฿{{ subtotal|floatformat:2 }}</span>
            </div>
            
            {% if restaurant.service_charge_percent > 0 %}
            <div class="flex justify-between text-gray-500 text-xs">
                <span>Service Charge ({{ restaurant.service_charge_percent }}%)</span>
                <span>฿{{ service_charge_amount|floatformat:2 }}</span>
            </div>
            {% endif %}

            {% if restaurant.vat_percent > 0 %}
            <div class="flex justify-between text-gray-500 text-xs">
                <span>VAT ({{ restaurant.vat_percent }}%)</span>
                <span>฿{{ vat_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
        </div>

        <div class="p-6 mt-auto bg-gray-50">

            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="clearCustomerScreen()" type="button" 
                    class="flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-3 rounded-xl hover:bg-gray-100 hover:text-red-600 font-bold transition shadow-sm text-sm">
                    🚫 ปิดจอ
                </button>
                <button onclick="sendToCustomer()" type="button" 
                    class="flex items-center justify-center gap-2 bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-bold shadow-md transition hover:-translate-y-0.5 text-sm">
                    🚀 โชว์ยอดลูกค้า
                </button>
            </div>
            
            <form method="post" action="{% url 'close_bill' table.id %}" onsubmit="if(confirm('ยืนยันรับชำระเงิน? รายการจะถูกปิดทันที')) { return handleCloseBill(event); } else { return false; }">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wide">วิธีชำระเงิน</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="cash" class="peer sr-only" checked>
                            <div class="text-center border rounded-lg p-2 text-gray-600 peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-700 transition">
                                💵 เงินสด
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="payment_method" value="qr" class="peer sr-only">
                            <div class="text-center border rounded-lg p-2 text-gray-600 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition">
                                📲 สแกนจ่าย
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                    ✅ รับชำระเงิน / ปิดโต๊ะ
                </button>
            </form>
            
            <button onclick="window.print()" class="w-full mt-4 text-gray-400 hover:text-gray-600 text-xs py-2 flex items-center justify-center gap-1 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                พิมพ์ใบเสร็จ (Receipt)
            </button>
        </div>
    </div>
</div>

<style>
    @media print {
        body * { visibility: hidden; height: 0; overflow: hidden; }
        #printable-area, #printable-area * { visibility: visible; height: auto; overflow: visible; }
        #printable-area { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
    }
</style>

<div id="printable-area" class="hidden print:block p-2 bg-white text-black font-mono text-xs leading-tight">
    <div class="text-center mb-2">
        <h1 class="text-base font-bold">{{ restaurant.name }}</h1>
        <p class="text-[10px]">{{ restaurant.address }}</p>
        <p class="text-[10px]">Tel: {{ restaurant.phone }}</p>
        <div class="border-b border-black border-dashed my-2"></div>
        <div class="flex justify-between">
            <span>โต๊ะ: {{ table.name }}</span>
            <span>{% now "d/m/y H:i" %}</span>
        </div>
    </div>

    <table class="w-full mb-2">
        <thead>
            <tr class="border-b border-black border-dashed">
                <th class="text-left py-1">รายการ</th>
                <th class="text-right py-1">รวม</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order_items %}
            <tr>
                <td class="py-1">
                    <div>{{ item.menu_name }}</div>
                    <div class="text-[10px] pl-2 text-gray-600">x{{ item.quantity }} @{{ item.price|floatformat:0 }}</div>
                </td>
                <td class="text-right align-top py-1">{{ item.total|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="border-t border-black border-dashed my-2"></div>

    <div class="flex justify-between">
        <span>รวมเงิน</span>
        <span>{{ subtotal|floatformat:2 }}</span>
    </div>
    
    {% if restaurant.service_charge_percent > 0 %}
    <div class="flex justify-between">
        <span>S.C. {{ restaurant.service_charge_percent }}%</span>
        <span>{{ service_charge_amount|floatformat:2 }}</span>
    </div>
    {% endif %}

    {% if restaurant.vat_percent > 0 %}
    <div class="flex justify-between">
        <span>VAT {{ restaurant.vat_percent }}%</span>
        <span>{{ vat_amount|floatformat:2 }}</span>
    </div>
    {% endif %}

    <div class="flex justify-between text-lg font-bold mt-2 border-t border-black pt-1">
        <span>สุทธิ</span>
        <span>{{ grand_total|floatformat:2 }}</span>
    </div>

    <div class="text-center mt-4 text-[10px]">
        <p>ขอบคุณที่ใช้บริการ</p>
        <p class="mt-1">** ใบเสร็จรับเงินอย่างย่อ **</p>
    </div>
</div>

<div id="raw-order-data" style="display: none;">
    {% for item in order_items %}
    <div 
        data-name="{{ item.menu_name }}" 
        data-quantity="{{ item.quantity }}" 
        data-price="฿{{ item.total|floatformat:2 }}"
    ></div>
    {% endfor %}
</div>

<script>
    const restaurantId = "{{ restaurant.id|default:'' }}"; 
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsScheme + '://' + window.location.host + '/ws/restaurant/' + restaurantId + '/';
    
    let socket = new WebSocket(wsUrl);

    socket.onopen = f